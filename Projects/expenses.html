<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>✦</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* ─── CSS Variables (matching navajitd.github.io) ─── */
        :root {
            --text-color: #0a1f00;
            --bg-color: #fff;
            --accent-color: #2563eb;
            --muted-color: #6b7280;
            --border-color: #e5e7eb;
            --font-sans: "Inconsolata", monospace;
            --secondary-color: #374151;
            --highlight-color: #f59e0b;
            --card-bg: #f9fafb;
            --card-hover: rgba(37, 99, 235, 0.03);
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --overlay-bg: rgba(0, 0, 0, 0.4);
            --input-bg: #fff;
            --input-border: #d1d5db;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
        }
        [data-theme="colorful"] {
            color-scheme: dark;
            --text-color: #d4e4d1;
            --bg-color: #131a12;
            --accent-color: #4ade80;
            --muted-color: #7a9476;
            --border-color: #2a3a28;
            --secondary-color: #ea580c;
            --highlight-color: #eab308;
            --card-bg: #1a2419;
            --card-hover: rgba(74, 222, 128, 0.05);
            --success-color: #4ade80;
            --danger-color: #f87171;
            --input-bg: #1e2b1d;
            --input-border: #344633;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.2);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.4);
        }

        /* ─── Reset & Base ─── */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body {
            font-family: var(--font-sans);
            color: var(--text-color);
            background-color: var(--bg-color);
            line-height: 1.65;
            max-width: 44rem;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
        }
        a { color: var(--accent-color); text-decoration: none; transition: color 0.3s ease; }
        a:hover { text-decoration: underline; }

        /* ─── Header ─── */
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .header-left { display: flex; align-items: center; gap: 0.75rem; }
        .header-left h1 {
            font-size: 1.15rem; font-weight: 600; letter-spacing: -0.02em;
        }
        .header-left .icon { font-size: 1.3rem; }
        .header-right { display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0; }
        .user-avatar {
            width: 28px; height: 28px; border-radius: 50%;
            border: 1.5px solid var(--border-color); cursor: pointer;
            transition: border-color 0.3s ease;
        }
        .user-avatar:hover { border-color: var(--accent-color); }

        /* ─── Theme Toggle ─── */
        .theme-toggle {
            width: 2.5rem; height: 2rem; border-radius: 6px;
            border: 1px solid var(--border-color); background: var(--bg-color);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease; position: relative; flex-shrink: 0;
        }
        .theme-toggle:hover { border-color: var(--accent-color); }
        .theme-toggle svg {
            width: 16px; height: 16px; stroke: var(--text-color);
            fill: none; stroke-width: 1.5; transition: all 0.3s ease;
        }
        .theme-toggle:hover svg { stroke: var(--accent-color); }
        .icon-colorful { opacity: 0; position: absolute; }
        .icon-original { opacity: 1; }
        [data-theme="colorful"] .icon-colorful { opacity: 1; }
        [data-theme="colorful"] .icon-original { opacity: 0; }

        /* ─── Tab Navigation ─── */
        .tab-nav {
            display: flex; gap: 0; margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }
        .tab-btn {
            font-family: var(--font-sans); font-size: 0.85rem; font-weight: 500;
            padding: 0.65rem 1.1rem; background: none; border: none;
            color: var(--muted-color); cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease; letter-spacing: 0.01em;
        }
        .tab-btn:hover { color: var(--text-color); }
        .tab-btn.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        .tab-content { display: none; animation: fadeIn 0.25s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

        /* ─── Login Screen ─── */
        .login-screen {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; min-height: 60vh; gap: 1.5rem; text-align: center;
        }
        .login-screen h2 { font-size: 1.4rem; font-weight: 600; }
        .login-screen p { color: var(--muted-color); max-width: 28rem; }
        .login-btn {
            font-family: var(--font-sans); font-size: 0.9rem; font-weight: 500;
            padding: 0.7rem 1.8rem; border-radius: 6px;
            background: var(--accent-color); color: #fff;
            border: none; cursor: pointer; transition: all 0.2s ease;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .login-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .login-btn svg { width: 18px; height: 18px; }

        /* ─── Quick Add Form ─── */
        .quick-add { margin-bottom: 2rem; }
        .form-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 0.85rem;
        }
        .form-group { display: flex; flex-direction: column; gap: 0.3rem; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label {
            font-size: 0.78rem; font-weight: 500; color: var(--muted-color);
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        .form-group input,
        .form-group select {
            font-family: var(--font-sans); font-size: 0.9rem;
            padding: 0.55rem 0.7rem; border-radius: 5px;
            border: 1px solid var(--input-border); background: var(--input-bg);
            color: var(--text-color); transition: border-color 0.2s ease;
            outline: none;
        }
        .form-group input:focus,
        .form-group select:focus { border-color: var(--accent-color); }
        .form-group input::placeholder { color: var(--muted-color); opacity: 0.6; }

        /* Amount input special styling */
        .amount-input-wrap {
            position: relative; display: flex; align-items: center;
        }
        .amount-input-wrap .currency {
            position: absolute; left: 0.7rem; font-size: 0.9rem;
            color: var(--muted-color); pointer-events: none; font-weight: 500;
        }
        .amount-input-wrap input { padding-left: 1.6rem; }

        /* Shared expense toggle */
        .shared-row {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.4rem 0; font-size: 0.85rem;
        }
        .shared-row input[type="checkbox"] {
            accent-color: var(--accent-color); width: 16px; height: 16px; cursor: pointer;
        }
        .split-fields {
            display: none; grid-template-columns: 1fr 1fr; gap: 0.85rem;
            margin-top: 0.5rem;
        }
        .split-fields.show { display: grid; }
        .split-info {
            font-size: 0.8rem; color: var(--accent-color); padding: 0.4rem 0;
            grid-column: 1 / -1;
        }

        .submit-btn {
            font-family: var(--font-sans); font-size: 0.9rem; font-weight: 600;
            width: 100%; padding: 0.7rem; margin-top: 0.5rem;
            border-radius: 6px; border: none;
            background: var(--accent-color); color: #fff;
            cursor: pointer; transition: all 0.2s ease;
            letter-spacing: 0.02em;
        }
        .submit-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .submit-btn:active { transform: translateY(0); }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* ─── Billing cycle info ─── */
        .billing-info {
            font-size: 0.8rem; color: var(--accent-color);
            padding: 0.35rem 0.6rem; margin-top: 0.3rem;
            background: rgba(37, 99, 235, 0.06); border-radius: 4px;
            grid-column: 1 / -1;
        }
        [data-theme="colorful"] .billing-info { background: rgba(74, 222, 128, 0.1); }

        /* ─── Recent Expenses List ─── */
        .recent-list { display: flex; flex-direction: column; gap: 0; }
        .recent-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.85rem 0; border-bottom: 1px solid var(--border-color);
            transition: background 0.15s ease;
        }
        .recent-item:last-child { border-bottom: none; }
        .recent-item-left { display: flex; flex-direction: column; gap: 0.15rem; }
        .recent-item-name { font-weight: 500; font-size: 0.9rem; }
        .recent-item-meta {
            font-size: 0.78rem; color: var(--muted-color);
            display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;
        }
        .recent-item-meta .dot { width: 3px; height: 3px; border-radius: 50%; background: var(--muted-color); }
        .recent-item-amount { font-weight: 600; font-size: 0.95rem; white-space: nowrap; }
        .category-badge {
            font-size: 0.7rem; padding: 0.15rem 0.45rem;
            border-radius: 3px; background: rgba(37, 99, 235, 0.08);
            color: var(--accent-color); font-weight: 500;
        }
        [data-theme="colorful"] .category-badge { background: rgba(74, 222, 128, 0.12); }

        .empty-state {
            text-align: center; padding: 3rem 1rem; color: var(--muted-color);
        }
        .empty-state .icon { font-size: 2rem; margin-bottom: 0.75rem; }
        .empty-state p { font-size: 0.9rem; }

        /* ─── CSV Export ─── */
        .csv-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 0.5rem 0.75rem;
        }
        .csv-btn {
            font-family: var(--font-sans); font-size: 0.8rem; font-weight: 500;
            padding: 0.5rem 0.7rem; border-radius: 5px;
            border: 1px solid var(--border-color); background: var(--card-bg);
            color: var(--text-color); cursor: pointer;
            transition: all 0.2s ease; text-align: center;
        }
        .csv-btn:hover {
            border-color: var(--accent-color); color: var(--accent-color);
        }
        .csv-section-label {
            font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.05em;
            color: var(--muted-color); margin-bottom: 0.6rem;
        }
        @media (max-width: 600px) {
            .csv-grid { grid-template-columns: 1fr 1fr; }
        }

        /* ─── Analytics ─── */
        .analytics-section { margin-bottom: 2rem; }
        .filter-row {
            display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap;
        }
        .filter-row select {
            font-family: var(--font-sans); font-size: 0.82rem;
            padding: 0.45rem 0.65rem; border-radius: 5px;
            border: 1px solid var(--input-border); background: var(--input-bg);
            color: var(--text-color); outline: none; cursor: pointer;
            flex: 1; min-width: 120px;
        }
        .filter-row select:focus { border-color: var(--accent-color); }

        /* Metrics row */
        .metrics-row {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem; margin-bottom: 2rem;
        }
        .metric-card {
            padding: 1rem; border-radius: 6px;
            border: 1px solid var(--border-color); background: var(--card-bg);
            transition: all 0.2s ease;
        }
        .metric-card .label {
            font-size: 0.72rem; text-transform: uppercase;
            letter-spacing: 0.05em; color: var(--muted-color); margin-bottom: 0.3rem;
        }
        .metric-card .value {
            font-size: 1.15rem; font-weight: 700; line-height: 1.2;
        }
        .metric-card .sub {
            font-size: 0.72rem; color: var(--muted-color); margin-top: 0.2rem;
        }

        /* Sub-tabs for analytics */
        .sub-tabs {
            display: flex; gap: 0; margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color); overflow-x: auto;
        }
        .sub-tab-btn {
            font-family: var(--font-sans); font-size: 0.78rem; font-weight: 500;
            padding: 0.5rem 0.85rem; background: none; border: none;
            color: var(--muted-color); cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease; white-space: nowrap;
        }
        .sub-tab-btn:hover { color: var(--text-color); }
        .sub-tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }

        .chart-panel { display: none; animation: fadeIn 0.25s ease; }
        .chart-panel.active { display: block; }
        .chart-container {
            position: relative; width: 100%;
            max-height: 380px; margin: 0 auto;
        }
        .chart-container canvas { max-height: 380px; }

        /* Trend toggle */
        .trend-toggle {
            display: flex; gap: 0; margin-bottom: 1rem;
            border: 1px solid var(--border-color); border-radius: 5px;
            overflow: hidden; width: fit-content;
        }
        .trend-toggle-btn {
            font-family: var(--font-sans); font-size: 0.78rem;
            padding: 0.35rem 0.85rem; background: var(--bg-color);
            border: none; cursor: pointer; color: var(--muted-color);
            transition: all 0.2s ease;
        }
        .trend-toggle-btn.active {
            background: var(--accent-color); color: #fff;
        }
        .trend-toggle-btn:not(:last-child) {
            border-right: 1px solid var(--border-color);
        }

        /* Category table */
        .category-table {
            width: 100%; border-collapse: collapse;
            font-size: 0.82rem; margin-top: 1.5rem;
        }
        .category-table th {
            text-align: left; padding: 0.5rem 0.6rem;
            border-bottom: 2px solid var(--border-color);
            font-size: 0.72rem; text-transform: uppercase;
            letter-spacing: 0.05em; color: var(--muted-color);
        }
        .category-table td {
            padding: 0.5rem 0.6rem;
            border-bottom: 1px solid var(--border-color);
        }
        .category-table tr:last-child td { border-bottom: none; }
        .pct-bar {
            height: 4px; border-radius: 2px;
            background: var(--accent-color); display: inline-block;
            vertical-align: middle; margin-left: 0.4rem;
            transition: width 0.4s ease;
        }

        /* Theme legend */
        .theme-legend {
            font-size: 0.8rem; color: var(--muted-color);
            margin-top: 1.2rem; padding: 0.8rem;
            background: var(--card-bg); border-radius: 5px;
            border: 1px solid var(--border-color);
        }
        .theme-legend strong { color: var(--text-color); }

        /* ─── Toast ─── */
        .toast {
            position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%) translateY(100px);
            font-family: var(--font-sans); font-size: 0.85rem; font-weight: 500;
            padding: 0.7rem 1.4rem; border-radius: 6px;
            background: var(--text-color); color: var(--bg-color);
            box-shadow: var(--shadow-lg); z-index: 999;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none; white-space: nowrap;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.success { background: var(--success-color); color: #fff; }
        .toast.error { background: var(--danger-color); color: #fff; }

        /* ─── Loading spinner ─── */
        .spinner {
            width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff; border-radius: 50%;
            animation: spin 0.6s linear infinite; display: inline-block;
            vertical-align: middle; margin-right: 0.4rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .page-spinner {
            display: flex; align-items: center; justify-content: center;
            min-height: 40vh; color: var(--muted-color); gap: 0.6rem;
        }
        .page-spinner .dot-pulse { display: flex; gap: 0.3rem; }
        .page-spinner .dot-pulse span {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--accent-color); animation: pulse 1.2s ease infinite;
        }
        .page-spinner .dot-pulse span:nth-child(2) { animation-delay: 0.2s; }
        .page-spinner .dot-pulse span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse { 0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); } 40% { opacity: 1; transform: scale(1.2); } }

        /* ─── Responsive ─── */
        @media (max-width: 600px) {
            body { padding: 1.2rem 1rem; }
            .form-grid { grid-template-columns: 1fr; }
            .split-fields { grid-template-columns: 1fr; }
            .metrics-row { grid-template-columns: 1fr; }
            .metric-card .value { font-size: 1.05rem; }
            .tab-btn { padding: 0.55rem 0.8rem; font-size: 0.8rem; }
            .filter-row { flex-direction: column; }
            .filter-row select { width: 100%; }
            .recent-item { padding: 0.7rem 0; }
        }

        /* ─── Sign out dropdown ─── */
        .user-menu { position: relative; }
        .user-dropdown {
            position: absolute; top: 100%; right: 0; margin-top: 0.4rem;
            background: var(--bg-color); border: 1px solid var(--border-color);
            border-radius: 6px; box-shadow: var(--shadow-md);
            padding: 0.3rem; min-width: 140px; display: none; z-index: 50;
        }
        .user-dropdown.show { display: block; }
        .user-dropdown button {
            font-family: var(--font-sans); font-size: 0.82rem;
            width: 100%; text-align: left; padding: 0.5rem 0.7rem;
            border: none; background: none; cursor: pointer;
            color: var(--text-color); border-radius: 4px;
            transition: background 0.15s ease;
        }
        .user-dropdown button:hover { background: var(--card-bg); }

        /* ─── Scrollbar ─── */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
    </style>
</head>
<body>

    <!-- ─── HEADER ─── -->
    <header>
        <div class="header-left">
            <span class="icon">✦</span>
            <h1>Expense Tracker</h1>
        </div>
        <div class="header-right">
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                <svg class="icon-original" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>
                <svg class="icon-colorful" viewBox="0 0 24 24"><path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446A9 9 0 1 1 12 3z"/></svg>
            </button>
            <div class="user-menu" id="userMenu" style="display:none;">
                <img class="user-avatar" id="userAvatar" src="" alt="User" onclick="toggleUserMenu()">
                <div class="user-dropdown" id="userDropdown">
                    <button onclick="signOut()">Sign out</button>
                </div>
            </div>
        </div>
    </header>

    <!-- ─── LOGIN SCREEN ─── -->
    <div id="loginScreen" class="login-screen">
        <div style="font-size: 2.5rem;">✦</div>
        <h2>Expense Tracker</h2>
        <p>Track spending fast with clarity. Record any expense in under 5 seconds.</p>
        <button class="login-btn" onclick="signInWithGoogle()">
            <svg viewBox="0 0 24 24" fill="none"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18A10.96 10.96 0 0 0 1 12c0 1.77.42 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
            Sign in with Google
        </button>
    </div>

    <!-- ─── MAIN APP ─── -->
    <div id="mainApp" style="display:none;">
        <!-- Tab Navigation -->
        <nav class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('add')">Add Expense</button>
            <button class="tab-btn" onclick="switchTab('recent')">Recent</button>
            <button class="tab-btn" onclick="switchTab('analytics')">Analytics</button>
        </nav>

        <!-- ─── ADD EXPENSE TAB ─── -->
        <div id="tab-add" class="tab-content active">
            <div class="quick-add">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="expName">Expense Name</label>
                        <input type="text" id="expName" placeholder="e.g. Uber to office" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="expCategory">Category</label>
                        <select id="expCategory">
                            <option value="Miscellaneous">Miscellaneous</option>
                            <option value="Bike">Bike</option>
                            <option value="Auto/Cab">Auto/Cab</option>
                            <option value="Public transport">Public transport</option>
                            <option value="Groceries">Groceries</option>
                            <option value="Eating out">Eating out</option>
                            <option value="Party">Party</option>
                            <option value="Household supplies">Household supplies</option>
                            <option value="Education">Education</option>
                            <option value="Gift">Gift</option>
                            <option value="Cinema">Cinema</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Rent/Maintenance">Rent/Maintenance</option>
                            <option value="Furniture">Furniture</option>
                            <option value="Services">Services</option>
                            <option value="Electricity">Electricity</option>
                            <option value="Internet">Internet</option>
                            <option value="Investment">Investment</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Medical expenses">Medical expenses</option>
                            <option value="Flights">Flights</option>
                            <option value="Travel">Travel</option>
                            <option value="Clothes">Clothes</option>
                            <option value="Gas">Gas</option>
                            <option value="Phone">Phone</option>
                            <option value="Liquor">Liquor</option>
                            <option value="Games/Sports">Games/Sports</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expPayment">Payment Method</label>
                        <select id="expPayment">
                            <option value="Cred UPI">Cred UPI</option>
                            <option value="Credit card">Credit card</option>
                            <option value="GPay UPI">GPay UPI</option>
                            <option value="Pine Perks">Pine Perks</option>
                            <option value="Cash">Cash</option>
                            <option value="Debit card">Debit card</option>
                            <option value="Net Banking">Net Banking</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expAmount">Amount</label>
                        <div class="amount-input-wrap">
                            <span class="currency">₹</span>
                            <input type="number" id="expAmount" placeholder="0.00" step="0.01" min="0" inputmode="decimal">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="expDate">Date</label>
                        <input type="date" id="expDate">
                    </div>
                    <div id="billingInfo" class="billing-info" style="display:none;"></div>
                    <div id="cardPicker" class="form-group full-width" style="display:none;">
                        <label>Credit Card</label>
                        <div style="display:flex;gap:0.6rem;">
                            <label style="display:flex;align-items:center;gap:0.35rem;cursor:pointer;font-size:0.88rem;text-transform:none;">
                                <input type="radio" name="cardType" value="Sapphiro" style="accent-color:var(--accent-color);" checked> Sapphiro
                            </label>
                            <label style="display:flex;align-items:center;gap:0.35rem;cursor:pointer;font-size:0.88rem;text-transform:none;">
                                <input type="radio" name="cardType" value="Neucard" style="accent-color:var(--accent-color);"> Neucard
                            </label>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <div class="shared-row">
                            <input type="checkbox" id="expShared" onchange="toggleShared()">
                            <label for="expShared" style="text-transform:none; font-size:0.85rem; cursor:pointer;">Shared expense</label>
                        </div>
                        <div class="split-fields" id="splitFields">
                            <div class="form-group">
                                <label for="splitCount">Split Between</label>
                                <input type="number" id="splitCount" value="2" min="1" step="1" oninput="updateSplit()">
                            </div>
                            <div class="form-group">
                                <label for="splitAmount">Your Share (₹)</label>
                                <input type="number" id="splitAmount" step="0.01" min="0">
                            </div>
                            <div class="split-info" id="splitInfo"></div>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <button class="submit-btn" id="submitBtn" onclick="addExpense()">
                            Add Expense
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ─── RECENT TAB ─── -->
        <div id="tab-recent" class="tab-content">
            <div id="recentList" class="recent-list"></div>
            <div id="csvExportSection" style="margin-top:1.5rem; padding-top:1rem; border-top:1px solid var(--border-color);"></div>
        </div>

        <!-- ─── ANALYTICS TAB ─── -->
        <div id="tab-analytics" class="tab-content">
            <div class="analytics-section">
                <!-- Filters -->
                <div class="filter-row">
                    <select id="filterMonth" onchange="refreshAnalytics()"></select>
                    <select id="filterYear" onchange="refreshAnalytics()"></select>
                </div>
                <!-- Metrics -->
                <div class="metrics-row" id="metricsRow"></div>
                <!-- Sub-tabs -->
                <div class="sub-tabs">
                    <button class="sub-tab-btn active" onclick="switchSubTab('categories')">Categories</button>
                    <button class="sub-tab-btn" onclick="switchSubTab('trends')">Trends</button>
                    <button class="sub-tab-btn" onclick="switchSubTab('payments')">Payments</button>
                    <button class="sub-tab-btn" onclick="switchSubTab('themes')">Themes</button>
                </div>
                <!-- Chart panels -->
                <div id="panel-categories" class="chart-panel active">
                    <div class="chart-container"><canvas id="chartCategories"></canvas></div>
                    <div id="categoryTable"></div>
                </div>
                <div id="panel-trends" class="chart-panel">
                    <div class="trend-toggle">
                        <button class="trend-toggle-btn active" onclick="setTrendView('weekly', this)">Weekly</button>
                        <button class="trend-toggle-btn" onclick="setTrendView('monthly', this)">Monthly</button>
                    </div>
                    <div class="chart-container"><canvas id="chartTrends"></canvas></div>
                </div>
                <div id="panel-payments" class="chart-panel">
                    <div class="chart-container" style="max-height:320px;"><canvas id="chartPayments"></canvas></div>
                </div>
                <div id="panel-themes" class="chart-panel">
                    <div class="chart-container" style="max-height:320px;"><canvas id="chartThemes"></canvas></div>
                    <div class="theme-legend">
                        <strong>Cost of living:</strong> Bike, Public transport, Groceries, Household supplies, Rent/Maintenance, Furniture, Services, Electricity, Internet, Insurance, Medical expenses, Gas, Phone<br><br>
                        <strong>Going out:</strong> Auto/Cab, Eating out, Party, Cinema, Entertainment, Liquor, Travel, Games/Sports<br><br>
                        <strong>Incidentals:</strong> Education, Gift, Investment, Flights, Clothes
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ─── TOAST ─── -->
    <div class="toast" id="toast"></div>

    <!-- ─── Firebase SDK (compat) ─── -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <script>
    /* ═══════════════════════════════════════════════════
       FIREBASE CONFIG — Replace with your own config
       ═══════════════════════════════════════════════════ */
    const firebaseConfig = {
        apiKey: "AIzaSyDWK-pRnYW1uYS2IfqfW-H9lNNzB-UZlFc",
        authDomain: "expense-tracker-navajitd.firebaseapp.com",
        projectId: "expense-tracker-navajitd",
        storageBucket: "expense-tracker-navajitd.firebasestorage.app",
        messagingSenderId: "417980148545",
        appId: "1:417980148545:web:b8a7a0bdb59905a8098fc0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /* ─── State ─── */
    let currentUser = null;
    let allExpenses = [];
    let chartInstances = {};
    let currentTrendView = 'weekly';
    let chartjsLoaded = false;
    let chartjsLoading = false;

    /* ─── Theme Categories (matching Streamlit app) ─── */
    const THEME_MAP = {
        'Cost of living': ['Bike','Public transport','Groceries','Household supplies','Rent/Maintenance','Furniture','Services','Electricity','Internet','Insurance','Medical expenses','Gas','Phone'],
        'Going out': ['Auto/Cab','Eating out','Party','Cinema','Entertainment','Liquor','Travel','Games/Sports'],
        'Incidentals': ['Education','Gift','Investment','Flights','Clothes']
    };

    function getTheme(category) {
        for (const [theme, cats] of Object.entries(THEME_MAP)) {
            if (cats.includes(category)) return theme;
        }
        return 'Other';
    }

    /* ─── Billing Cycle ─── */
    function getBillingCycle(dateObj) {
        const day = dateObj.getDate();
        let startMonth, endMonth;
        if (day < 16) {
            const lastMonth = new Date(dateObj.getFullYear(), dateObj.getMonth() - 1, 25);
            startMonth = lastMonth;
            endMonth = new Date(dateObj.getFullYear(), dateObj.getMonth(), 25);
        } else {
            startMonth = new Date(dateObj.getFullYear(), dateObj.getMonth(), 25);
            endMonth = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, 25);
        }
        const fmt = d => d.toLocaleString('en', { month: 'short' });
        return `${fmt(startMonth)} 25 - ${fmt(endMonth)} 25`;
    }

    /* ═══════════════════════════════════════════════════
       AUTH
       ═══════════════════════════════════════════════════ */
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userMenu').style.display = 'block';
            document.getElementById('userAvatar').src = user.photoURL || '';
            initApp();
        } else {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('userMenu').style.display = 'none';
        }
    });

    function signInWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(e => {
            toast('Sign-in failed: ' + e.message, 'error');
        });
    }

    function signOut() {
        auth.signOut();
        document.getElementById('userDropdown').classList.remove('show');
    }

    function toggleUserMenu() {
        document.getElementById('userDropdown').classList.toggle('show');
    }

    // Close dropdown on outside click
    document.addEventListener('click', e => {
        const menu = document.getElementById('userMenu');
        if (menu && !menu.contains(e.target)) {
            document.getElementById('userDropdown').classList.remove('show');
        }
    });

    /* ═══════════════════════════════════════════════════
       AUTO-CATEGORIZATION (keyword match, instant)
       ═══════════════════════════════════════════════════ */
    const CATEGORY_KEYWORDS = {
        'Auto/Cab': ['uber','ola','cab','auto','taxi','ride','rapido','lyft'],
        'Eating out': ['zomato','swiggy','restaurant','cafe','coffee','chai','dinner','lunch','breakfast','biryani','pizza','burger','dominos','starbucks','mcd','kfc','dine'],
        'Groceries': ['bigbasket','blinkit','zepto','grocery','vegetables','fruits','milk','supermarket','dmart','more','reliance fresh'],
        'Public transport': ['metro','bus','train','namma','bmtc','irctc','ticket'],
        'Bike': ['petrol','fuel','servicing','helmet','tyre'],
        'Rent/Maintenance': ['rent','maintenance','society','hoa'],
        'Electricity': ['electricity','bescom','power bill'],
        'Internet': ['wifi','broadband','jio','airtel','internet','bsnl'],
        'Phone': ['recharge','mobile','phone bill'],
        'Medical expenses': ['pharmacy','medicine','doctor','hospital','clinic','apollo','medplus','1mg','pharmeasy'],
        'Entertainment': ['netflix','spotify','prime','hotstar','subscription','youtube'],
        'Cinema': ['movie','cinema','pvr','inox','film','imax'],
        'Clothes': ['clothes','shirt','shoes','amazon fashion','myntra','ajio','shopping'],
        'Flights': ['flight','airline','indigo','spicejet','air india','vistara','goair','airport'],
        'Travel': ['hotel','hostel','airbnb','oyo','booking','resort','trip'],
        'Education': ['course','book','udemy','coursera','class','tuition'],
        'Gift': ['gift','present','birthday','anniversary'],
        'Investment': ['invest','mutual fund','sip','stock','zerodha','groww'],
        'Insurance': ['insurance','premium','lic','policy'],
        'Liquor': ['beer','wine','whiskey','liquor','bar','pub','brewery'],
        'Party': ['party','celebration','event'],
        'Games/Sports': ['gym','sport','badminton','cricket','football','game','decathlon'],
        'Household supplies': ['cleaning','detergent','mop','broom','tissue','toiletries'],
        'Furniture': ['furniture','ikea','chair','desk','table','shelf','mattress'],
        'Services': ['haircut','salon','laundry','dry clean','plumber','electrician','repair'],
        'Gas': ['gas','cylinder','lpg','indane','bharat gas','hp gas'],
    };

    function autoCategory(name) {
        const lower = name.toLowerCase();
        for (const [cat, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
            if (keywords.some(kw => lower.includes(kw))) return cat;
        }
        return null;
    }

    /* ═══════════════════════════════════════════════════
       INIT
       ═══════════════════════════════════════════════════ */
    function initApp() {
        // Set today's date
        document.getElementById('expDate').value = new Date().toISOString().split('T')[0];

        // Listen for payment method changes for billing cycle
        document.getElementById('expPayment').addEventListener('change', updateBillingInfo);
        document.getElementById('expDate').addEventListener('change', updateBillingInfo);
        updateBillingInfo();

        // Auto-categorize on expense name input (debounced, 150ms)
        let autoTimer = null;
        document.getElementById('expName').addEventListener('input', function() {
            clearTimeout(autoTimer);
            autoTimer = setTimeout(() => {
                const match = autoCategory(this.value);
                if (match) {
                    document.getElementById('expCategory').value = match;
                }
            }, 150);
        });

        // Load data from Firestore
        loadExpenses();
    }

    /* ═══════════════════════════════════════════════════
       FIRESTORE OPERATIONS
       ═══════════════════════════════════════════════════ */
    function getCollection() {
        return db.collection('users').doc(currentUser.uid).collection('expenses');
    }

    async function loadExpenses() {
        try {
            const snap = await getCollection().orderBy('date', 'desc').get();
            allExpenses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            // Convert Firestore Timestamps to JS Dates
            allExpenses.forEach(e => {
                if (e.date && e.date.toDate) e.date = e.date.toDate();
                else if (typeof e.date === 'string') e.date = new Date(e.date);
                if (e.timestamp && e.timestamp.toDate) e.timestamp = e.timestamp.toDate();
            });
            renderRecent();
            initFilters();
            refreshAnalytics();
        } catch (err) {
            toast('Failed to load expenses', 'error');
            console.error(err);
        }
    }

    async function addExpense() {
        const name = document.getElementById('expName').value.trim();
        const category = document.getElementById('expCategory').value;
        const payment = document.getElementById('expPayment').value;
        const amount = parseFloat(document.getElementById('expAmount').value);
        const dateStr = document.getElementById('expDate').value;
        const shared = document.getElementById('expShared').checked;

        if (!name) { toast('Enter an expense name', 'error'); return; }
        if (!amount || amount <= 0) { toast('Enter a valid amount', 'error'); return; }
        if (!dateStr) { toast('Select a date', 'error'); return; }

        const dateObj = new Date(dateStr + 'T00:00:00');
        let finalAmount = amount;
        let originalAmount = amount;

        if (shared) {
            const splitAmt = parseFloat(document.getElementById('splitAmount').value);
            if (splitAmt > 0) finalAmount = splitAmt;
        }

        // Resolve payment method (Credit card → CC - Sapphiro / CC - Neucard)
        const resolvedPayment = payment === 'Credit card'
            ? 'CC - ' + (document.querySelector('input[name="cardType"]:checked')?.value || 'Sapphiro')
            : payment;

        const docData = {
            expenseName: name,
            category: category,
            amount: finalAmount,
            originalAmount: originalAmount,
            date: dateObj,
            month: dateObj.toLocaleString('en', { month: 'long' }),
            year: dateObj.getFullYear(),
            paymentMethod: resolvedPayment,
            shared: shared ? 'Yes' : 'No',
            billingCycle: payment === 'Credit card' ? getBillingCycle(dateObj) : '',
            timestamp: new Date()
        };

        if (shared) {
            docData.splitBetween = parseInt(document.getElementById('splitCount').value) || 2;
            docData.splitAmount = finalAmount;
        }

        // Optimistic UI: update instantly, write to Firestore in background
        allExpenses.unshift({ id: 'pending-' + Date.now(), ...docData });
        renderRecent();
        toast('Expense added!', 'success');
        resetForm();
        document.getElementById('expName').focus();

        // Fire-and-forget Firestore write
        getCollection().add({
            ...docData,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(err => {
            toast('Sync failed — will retry', 'error');
            console.error(err);
        });
    }

    /* ═══════════════════════════════════════════════════
       FORM HELPERS
       ═══════════════════════════════════════════════════ */
    function resetForm() {
        document.getElementById('expName').value = '';
        document.getElementById('expAmount').value = '';
        document.getElementById('expCategory').selectedIndex = 0;
        document.getElementById('expDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('expShared').checked = false;
        const sapphiro = document.querySelector('input[name="cardType"][value="Sapphiro"]');
        if (sapphiro) sapphiro.checked = true;
        toggleShared();
        updateBillingInfo();
    }

    function toggleShared() {
        const show = document.getElementById('expShared').checked;
        document.getElementById('splitFields').classList.toggle('show', show);
        if (show) updateSplit();
    }

    function updateSplit() {
        const amount = parseFloat(document.getElementById('expAmount').value) || 0;
        const count = parseInt(document.getElementById('splitCount').value) || 2;
        const split = count > 0 ? (amount / count) : 0;
        document.getElementById('splitAmount').value = split.toFixed(2);
        document.getElementById('splitInfo').textContent =
            amount > 0 ? `₹${amount.toFixed(2)} ÷ ${count} = ₹${split.toFixed(2)}` : '';
    }

    function updateBillingInfo() {
        const payment = document.getElementById('expPayment').value;
        const dateStr = document.getElementById('expDate').value;
        const el = document.getElementById('billingInfo');
        const cardPicker = document.getElementById('cardPicker');
        if (payment === 'Credit card' && dateStr) {
            el.textContent = 'Billing Cycle: ' + getBillingCycle(new Date(dateStr + 'T00:00:00'));
            el.style.display = 'block';
            cardPicker.style.display = 'block';
        } else {
            el.style.display = 'none';
            cardPicker.style.display = 'none';
        }
    }

    /* ═══════════════════════════════════════════════════
       TABS
       ═══════════════════════════════════════════════════ */
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach((b, i) => {
            b.classList.toggle('active', b.textContent.toLowerCase().includes(tab));
        });
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        if (tab === 'analytics') {
            if (chartjsLoaded) {
                refreshAnalytics();
            } else {
                loadChartJS().then(() => refreshAnalytics());
            }
        }
        if (tab === 'recent') renderRecent();
    }

    function loadChartJS() {
        if (chartjsLoaded) return Promise.resolve();
        if (chartjsLoading) return chartjsLoading;

        // Show loading state in analytics
        const panels = document.querySelectorAll('.chart-panel');
        const metricsRow = document.getElementById('metricsRow');
        metricsRow.innerHTML = '<div class="page-spinner" style="grid-column:1/-1;min-height:6rem;"><div class="dot-pulse"><span></span><span></span><span></span></div><span>Loading charts...</span></div>';

        chartjsLoading = new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js';
            script.onload = () => {
                chartjsLoaded = true;
                chartjsLoading = false;
                resolve();
            };
            script.onerror = () => {
                chartjsLoading = false;
                toast('Failed to load charts library', 'error');
                reject(new Error('Chart.js failed to load'));
            };
            document.head.appendChild(script);
        });

        return chartjsLoading;
    }

    function switchSubTab(panel) {
        document.querySelectorAll('.sub-tab-btn').forEach(b => {
            b.classList.toggle('active', b.textContent.toLowerCase().includes(panel.substring(0, 4)));
        });
        document.querySelectorAll('.chart-panel').forEach(c => c.classList.remove('active'));
        document.getElementById('panel-' + panel).classList.add('active');
    }

    /* ═══════════════════════════════════════════════════
       RECENT EXPENSES
       ═══════════════════════════════════════════════════ */
    function renderRecent() {
        const container = document.getElementById('recentList');
        const recent = allExpenses.slice(0, 10);

        if (recent.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="icon">📭</div>
                    <p>No expenses recorded yet</p>
                </div>`;
            return;
        }

        container.innerHTML = recent.map(e => {
            const d = e.date instanceof Date ? e.date : new Date(e.date);
            const dateStr = d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
            return `
                <div class="recent-item">
                    <div class="recent-item-left">
                        <span class="recent-item-name">${esc(e.expenseName)}</span>
                        <div class="recent-item-meta">
                            <span class="category-badge">${esc(e.category)}</span>
                            <span class="dot"></span>
                            <span>${dateStr}</span>
                            <span class="dot"></span>
                            <span>${esc(e.paymentMethod)}</span>
                            ${e.shared === 'Yes' ? '<span class="dot"></span><span>Shared</span>' : ''}
                        </div>
                    </div>
                    <span class="recent-item-amount">₹${e.amount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}</span>
                </div>`;
        }).join('');
        
        renderCSVExport();
    }

    function renderCSVExport() {
    const container = document.getElementById('csvExportSection');
    if (allExpenses.length === 0) { container.innerHTML = ''; return; }

    // Get unique month-year combos from data
    const monthYears = {};
    allExpenses.forEach(e => {
        const d = e.date instanceof Date ? e.date : new Date(e.date);
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        const label = d.toLocaleString('en', { month: 'short', year: 'numeric' });
        monthYears[key] = label;
    });

    const sorted = Object.entries(monthYears).sort((a, b) => b[0].localeCompare(a[0]));

    container.innerHTML = `
        <div class="csv-section-label">Export as CSV</div>
        <div class="csv-grid">
            ${sorted.map(([key, label]) =>
                `<button class="csv-btn" onclick="downloadCSV('${key}')">${label}</button>`
            ).join('')}
        </div>`;
    }

    function downloadCSV(monthKey) {
        const [year, month] = monthKey.split('-').map(Number);
        const filtered = allExpenses.filter(e => {
            const d = e.date instanceof Date ? e.date : new Date(e.date);
            return d.getFullYear() === year && d.getMonth() + 1 === month;
        });
    
        if (filtered.length === 0) { toast('No data for this month', 'error'); return; }
    
        const headers = ['Date', 'Expense', 'Category', 'Amount', 'Original Amount', 'Payment Method', 'Shared', 'Billing Cycle'];
        const rows = filtered.map(e => {
            const d = e.date instanceof Date ? e.date : new Date(e.date);
            return [
                d.toISOString().split('T')[0],
                `"${(e.expenseName || '').replace(/"/g, '""')}"`,
                e.category,
                e.amount,
                e.originalAmount || e.amount,
                e.paymentMethod,
                e.shared || 'No',
                e.billingCycle || ''
            ].join(',');
        });
    
        const csv = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const monthName = new Date(year, month - 1).toLocaleString('en', { month: 'long' });
        a.download = `expenses-${monthName}-${year}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        toast(`Downloaded ${monthName} ${year}`, 'success');
    }

    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    /* ═══════════════════════════════════════════════════
       ANALYTICS — FILTERS
       ═══════════════════════════════════════════════════ */
    function initFilters() {
        const months = [...new Set(allExpenses.map(e => e.date.getMonth()))].sort((a, b) => a - b);
        const years = [...new Set(allExpenses.map(e => e.date.getFullYear()))].sort();
        const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];

        const mSel = document.getElementById('filterMonth');
        const ySel = document.getElementById('filterYear');

        mSel.innerHTML = '<option value="all">All Months</option>' +
            months.map(m => `<option value="${m}" ${m === new Date().getMonth() ? 'selected' : ''}>${monthNames[m]}</option>`).join('');

        ySel.innerHTML = '<option value="all">All Years</option>' +
            years.map(y => `<option value="${y}" ${y === new Date().getFullYear() ? 'selected' : ''}>${y}</option>`).join('');
    }

    function getFilteredData() {
        const m = document.getElementById('filterMonth').value;
        const y = document.getElementById('filterYear').value;
        return allExpenses.filter(e => {
            if (m !== 'all' && e.date.getMonth() !== parseInt(m)) return false;
            if (y !== 'all' && e.date.getFullYear() !== parseInt(y)) return false;
            return true;
        });
    }

    /* ═══════════════════════════════════════════════════
       ANALYTICS — REFRESH
       ═══════════════════════════════════════════════════ */
    function refreshAnalytics() {
        const data = getFilteredData();
        renderMetrics(data);
        if (!chartjsLoaded) return; // Charts render once Chart.js is loaded
        renderCategoryChart(data);
        renderTrendChart(data);
        renderPaymentChart(data);
        renderThemeChart(data);
    }

    /* ─── Metrics ─── */
    function renderMetrics(data) {
        const container = document.getElementById('metricsRow');
        const total = data.reduce((s, e) => s + e.amount, 0);

        // Period label
        const mVal = document.getElementById('filterMonth').value;
        const yVal = document.getElementById('filterYear').value;
        const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        let periodLabel = 'All Time';
        if (mVal !== 'all' && yVal !== 'all') periodLabel = `${monthNames[parseInt(mVal)]} ${yVal}`;
        else if (mVal !== 'all') periodLabel = monthNames[parseInt(mVal)];
        else if (yVal !== 'all') periodLabel = yVal;

        // Avg daily
        let days = 1;
        if (data.length > 0) {
            const dates = data.map(e => e.date.getTime());
            days = Math.max(1, Math.ceil((Math.max(...dates) - Math.min(...dates)) / 86400000) + 1);
        }
        const avgDaily = total / days;

        // Top category (skip Rent/Maintenance if top)
        const catMap = {};
        data.forEach(e => { catMap[e.category] = (catMap[e.category] || 0) + e.amount; });
        const sorted = Object.entries(catMap).sort((a, b) => b[1] - a[1]);
        let topCat = 'N/A', topAmt = 0, catNote = '';
        if (sorted.length > 0) {
            if (sorted[0][0] === 'Rent/Maintenance' && sorted.length > 1) {
                topCat = sorted[1][0]; topAmt = sorted[1][1]; catNote = '(excl. Rent)';
            } else {
                topCat = sorted[0][0]; topAmt = sorted[0][1];
            }
        }

        container.innerHTML = `
            <div class="metric-card">
                <div class="label">Total Spent</div>
                <div class="value">₹${total.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                <div class="sub">${periodLabel}</div>
            </div>
            <div class="metric-card">
                <div class="label">Avg Daily</div>
                <div class="value">₹${avgDaily.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                <div class="sub">${days} days</div>
            </div>
            <div class="metric-card">
                <div class="label">Top Category</div>
                <div class="value" style="font-size:0.95rem;">${esc(topCat)}</div>
                <div class="sub">₹${topAmt.toLocaleString('en-IN', { minimumFractionDigits: 0 })} ${catNote}</div>
            </div>`;
    }

    /* ─── Category Bar Chart ─── */
    function renderCategoryChart(data) {
        const catMap = {};
        data.forEach(e => { catMap[e.category] = (catMap[e.category] || 0) + e.amount; });
        const sorted = Object.entries(catMap).sort((a, b) => b[1] - a[1]);
        const labels = sorted.map(s => s[0]);
        const values = sorted.map(s => s[1]);
        const total = values.reduce((a, b) => a + b, 0) || 1;

        destroyChart('chartCategories');
        const ctx = document.getElementById('chartCategories').getContext('2d');
        const accent = getComputedStyle(document.body).getPropertyValue('--accent-color').trim();

        chartInstances['chartCategories'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    data: values,
                    backgroundColor: accent + '99',
                    borderColor: accent,
                    borderWidth: 1,
                    borderRadius: 3,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        ticks: { callback: v => '₹' + v.toLocaleString('en-IN'), color: getCSS('--muted-color') },
                        grid: { color: getCSS('--border-color') + '44' }
                    },
                    y: {
                        ticks: { color: getCSS('--text-color'), font: { family: 'Inconsolata', size: 12 } },
                        grid: { display: false }
                    }
                }
            }
        });

        // Table
        const tableHtml = sorted.length ? `
            <table class="category-table">
                <tr><th>Category</th><th>Amount</th><th>Share</th></tr>
                ${sorted.map(([cat, amt]) => {
                    const pct = ((amt / total) * 100).toFixed(1);
                    return `<tr><td>${esc(cat)}</td><td>₹${amt.toLocaleString('en-IN', { minimumFractionDigits: 2 })}</td><td>${pct}%<span class="pct-bar" style="width:${pct * 0.8}px"></span></td></tr>`;
                }).join('')}
            </table>` : '<p class="empty-state">No data</p>';
        document.getElementById('categoryTable').innerHTML = tableHtml;
    }

    /* ─── Trend Line Chart ─── */
    function setTrendView(view, btnEl) {
        currentTrendView = view;
        document.querySelectorAll('.trend-toggle-btn').forEach(b => b.classList.remove('active'));
        if (btnEl) btnEl.classList.add('active');
        renderTrendChart(getFilteredData());
    }

    function renderTrendChart(data) {
        if (data.length === 0) {
            destroyChart('chartTrends');
            return;
        }

        // Group data
        const groups = {};
        data.forEach(e => {
            let key;
            if (currentTrendView === 'weekly') {
                const day = e.date.getDate();
                let range;
                if (day <= 7) range = '01-07';
                else if (day <= 14) range = '08-14';
                else if (day <= 21) range = '15-21';
                else if (day <= 28) range = '22-28';
                else {
                    const last = new Date(e.date.getFullYear(), e.date.getMonth() + 1, 0).getDate();
                    range = `29-${last}`;
                }
                const mon = e.date.toLocaleString('en', { month: 'short' });
                key = `${range} ${mon} ${e.date.getFullYear()}`;
            } else {
                key = e.date.toLocaleString('en', { month: 'short' }) + ' ' + e.date.getFullYear();
            }
            if (!groups[key]) groups[key] = {};
            if (!groups[key][e.category]) groups[key][e.category] = 0;
            groups[key][e.category] += e.amount;
        });

        // Sort keys chronologically
        const sortedKeys = Object.keys(groups).sort((a, b) => {
            const parseKey = k => {
                const parts = k.split(' ');
                if (currentTrendView === 'weekly') {
                    const dayStart = parseInt(parts[0].split('-')[0]);
                    const mon = new Date(Date.parse(parts[1] + ' 1, 2000')).getMonth();
                    const yr = parseInt(parts[2]);
                    return new Date(yr, mon, dayStart);
                } else {
                    return new Date(Date.parse(k.replace(/(\w+)\s(\d+)/, '$1 1, $2')));
                }
            };
            return parseKey(a) - parseKey(b);
        });

        // Get top 5 categories by total amount
        const catTotals = {};
        data.forEach(e => { catTotals[e.category] = (catTotals[e.category] || 0) + e.amount; });
        const topCats = Object.entries(catTotals).sort((a, b) => b[1] - a[1]).slice(0, 5).map(c => c[0]);

        const colors = ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];
        const datasets = topCats.map((cat, i) => ({
            label: cat,
            data: sortedKeys.map(k => groups[k][cat] || 0),
            borderColor: colors[i % colors.length],
            backgroundColor: colors[i % colors.length] + '22',
            borderWidth: 2,
            pointRadius: 4,
            tension: 0.3,
            fill: false,
        }));

        destroyChart('chartTrends');
        const ctx = document.getElementById('chartTrends').getContext('2d');
        chartInstances['chartTrends'] = new Chart(ctx, {
            type: 'line',
            data: { labels: sortedKeys, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { family: 'Inconsolata', size: 11 }, color: getCSS('--text-color'), padding: 15 }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: getCSS('--muted-color'), font: { family: 'Inconsolata', size: 10 }, maxRotation: 45 },
                        grid: { color: getCSS('--border-color') + '44' }
                    },
                    y: {
                        ticks: { callback: v => '₹' + v.toLocaleString('en-IN'), color: getCSS('--muted-color') },
                        grid: { color: getCSS('--border-color') + '44' }
                    }
                }
            }
        });
    }

    /* ─── Payment Donut Chart ─── */
    function renderPaymentChart(data) {
        const payMap = {};
        data.forEach(e => { payMap[e.paymentMethod] = (payMap[e.paymentMethod] || 0) + e.amount; });
        const labels = Object.keys(payMap);
        const values = Object.values(payMap);
        const colors = ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];

        destroyChart('chartPayments');
        const ctx = document.getElementById('chartPayments').getContext('2d');
        chartInstances['chartPayments'] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors.slice(0, labels.length),
                    borderWidth: 2,
                    borderColor: getCSS('--bg-color'),
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '55%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { family: 'Inconsolata', size: 11 }, color: getCSS('--text-color'), padding: 12 }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.label}: ₹${ctx.parsed.toLocaleString('en-IN', { minimumFractionDigits: 2 })} (${((ctx.parsed / ctx.dataset.data.reduce((a,b)=>a+b,0)) * 100).toFixed(1)}%)`
                        }
                    }
                }
            }
        });
    }

    /* ─── Theme Pie Chart ─── */
    function renderThemeChart(data) {
        const themeMap = {};
        data.forEach(e => {
            const t = getTheme(e.category);
            themeMap[t] = (themeMap[t] || 0) + e.amount;
        });
        const labels = Object.keys(themeMap);
        const values = Object.values(themeMap);
        const themeColors = {
            'Cost of living': '#7986CB',
            'Going out': '#FF8A65',
            'Incidentals': '#4DB6AC',
            'Other': '#9E9E9E'
        };
        const bgColors = labels.map(l => themeColors[l] || '#9E9E9E');

        destroyChart('chartThemes');
        const ctx = document.getElementById('chartThemes').getContext('2d');
        chartInstances['chartThemes'] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data: values,
                    backgroundColor: bgColors,
                    borderWidth: 2,
                    borderColor: getCSS('--bg-color'),
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '45%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { family: 'Inconsolata', size: 11 }, color: getCSS('--text-color'), padding: 12 }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.label}: ₹${ctx.parsed.toLocaleString('en-IN', { minimumFractionDigits: 2 })} (${((ctx.parsed / ctx.dataset.data.reduce((a,b)=>a+b,0)) * 100).toFixed(1)}%)`
                        }
                    }
                }
            }
        });
    }

    /* ─── Chart Utilities ─── */
    function destroyChart(id) {
        if (chartInstances[id]) { chartInstances[id].destroy(); delete chartInstances[id]; }
    }

    function getCSS(prop) {
        return getComputedStyle(document.body).getPropertyValue(prop).trim();
    }

    /* ═══════════════════════════════════════════════════
       THEME TOGGLE
       ═══════════════════════════════════════════════════ */
    function toggleTheme() {
        const body = document.body;
        if (body.getAttribute('data-theme') === 'colorful') {
            body.removeAttribute('data-theme');
            localStorage.setItem('theme', 'original');
        } else {
            body.setAttribute('data-theme', 'colorful');
            localStorage.setItem('theme', 'colorful');
        }
        // Re-render charts with new colors
        if (currentUser) refreshAnalytics();
    }

    // Load saved theme
    (function() {
        const saved = localStorage.getItem('theme');
        if (saved === 'colorful') {
            document.body.setAttribute('data-theme', 'colorful');
        } else if (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.setAttribute('data-theme', 'colorful');
        }
    })();

    /* ═══════════════════════════════════════════════════
       TOAST
       ═══════════════════════════════════════════════════ */
    function toast(msg, type = '') {
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.className = 'toast' + (type ? ' ' + type : '');
        requestAnimationFrame(() => el.classList.add('show'));
        setTimeout(() => el.classList.remove('show'), 2500);
    }

    /* ═══════════════════════════════════════════════════
       KEYBOARD SHORTCUT — Focus amount on 'a' key
       ═══════════════════════════════════════════════════ */
    document.addEventListener('keydown', e => {
        // Don't intercept if user is typing in an input
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;
        if (e.key === 'a' && !e.metaKey && !e.ctrlKey) {
            e.preventDefault();
            switchTab('add');
            document.getElementById('expName').focus();
        }
    });
    </script>
</body>
</html>
