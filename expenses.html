<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%232563eb;stop-opacity:1' /%3E%3Cstop offset='50%25' style='stop-color:%2316a34a;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23ea580c;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='6' fill='url(%23grad)'/%3E%3Ctext x='16' y='22' font-family='system-ui,-apple-system,sans-serif' font-size='16' font-weight='500' text-anchor='middle' fill='white'%3EN%3C/text%3E%3C/svg%3E">
    
    <title>Expense Tracker - Navajit D</title>
    
    <!-- Open Graph meta tags -->
    <meta property="og:title" content="Expense Tracker - Navajit D">
    <meta property="og:description" content="Personal expense tracking with AI-powered insights and spending optimization">
    <meta property="og:image" content="https://navajitd.github.io/assets/expense-tracker-thumbnail.png">
    <meta property="og:url" content="https://navajitd.github.io/expenses.html">
    <meta property="og:type" content="website">
    
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* Base Styles */
        :root {
            --text-color: #171717;
            --bg-color: #fff;
            --accent-color: #2563eb;
            --muted-color: #6b7280;
            --border-color: #e5e7eb;
            --font-sans: "Inconsolata", monospace;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html {
            font-size: 16px;
        }
        
        body {
            font-family: var(--font-sans);
            color: var(--text-color);
            background-color: var(--bg-color);
            line-height: 1.65;
            max-width: 42rem;
            margin: 0 auto;
            padding: 3rem 1.5rem;
        }
        
        a {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        p {
            margin-bottom: 1.5rem;
        }
        
        /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
        }
        
        .logo {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-color);
        }
        
        .logo a {
            color: var(--text-color);
        }
        
        .logo a:hover {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        nav ul {
            display: flex;
            gap: 1.5rem;
            list-style: none;
        }
        
        nav a {
            color: var(--text-color);
            font-size: 1rem;
        }
        
        nav a:hover {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        .sign-out-link {
            color: var(--text-color);
            cursor: pointer;
            border: none;
            background: none;
            font: inherit;
            font-size: 1rem;
            padding: 0;
        }
        
        .sign-out-link:hover {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        /* Authentication */
        .auth-container {
            text-align: center;
            padding: 4rem 0;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin: 2rem 0;
        }
        
        .auth-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .auth-description {
            color: var(--muted-color);
            margin-bottom: 2rem;
            font-size: 1.125rem;
        }
        
        .auth-features {
            text-align: left;
            max-width: 300px;
            margin: 0 auto 2rem;
        }
        
        .auth-features ul {
            list-style: none;
            padding: 0;
        }
        
        .auth-features li {
            padding: 0.5rem 0;
            position: relative;
            padding-left: 1.5rem;
        }
        
        .auth-features li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: var(--success-color);
            font-weight: bold;
        }
        
        #g_id_signin {
            display: inline-block;
            margin: 0 auto;
        }
        
        /* Page Header */
        .page-header {
            margin-bottom: 3rem;
        }
        
        .page-title {
            font-size: 2rem;
            line-height: 1.3;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .page-description {
            font-size: 1.125rem;
            color: var(--muted-color);
        }
        
        /* Tab Styles */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }
        
        .tab-button {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            font-family: inherit;
            font-size: 1rem;
            color: var(--muted-color);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-button:hover {
            color: var(--text-color);
        }
        
        .tab-button.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Form Styles */
        .form-container {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: inherit;
            font-size: 1rem;
        }
        
        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background: #1d4ed8;
        }
        
        button:disabled {
            background: var(--muted-color);
            cursor: not-allowed;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            padding: 1.5rem;
            background: #f9fafb;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--muted-color);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Charts */
        .charts-container {
            margin: 2rem 0;
        }
        
        .chart-wrapper {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        /* AI Insights Section */
        .ai-section {
            background: #f0f9ff;
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid #e0f2fe;
            margin-bottom: 2rem;
        }
        
        .ai-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-color);
        }
        
        .chat-container {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .chat-input {
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input input {
            flex: 1;
            margin: 0;
        }
        
        .chat-input button {
            padding: 0.75rem 1rem;
        }
        
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 6px;
        }
        
        .message.user {
            background: #e0f2fe;
            margin-left: 2rem;
        }
        
        .message.ai {
            background: #f0f9ff;
            margin-right: 2rem;
        }
        
        .message-content {
            margin: 0;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: var(--muted-color);
            margin-top: 0.5rem;
        }
        
        /* Insights Grid */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .insight-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .insight-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-color);
        }
        
        .insight-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }
        
        .insight-description {
            color: var(--muted-color);
            font-size: 0.875rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 640px) {
            body {
                padding: 2rem 1rem;
            }
            
            header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            nav ul {
                gap: 1rem;
            }
            
            .page-title {
                font-size: 1.75rem;
            }
            
            .tabs {
                overflow-x: auto;
            }
            
            .tab-button {
                white-space: nowrap;
                padding: 1rem;
            }
        }
        
        /* Hidden class */
        .hidden {
            display: none !important;
        }
        
        /* Success/Error Messages */
        .message-banner {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        
        .message-banner.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .message-banner.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="auth-screen">
        <header>
            <div class="logo">
                <a href="/">Navajit D</a>
            </div>
        </header>
        
        <div class="auth-container">
            <h1 class="auth-title">Expense Tracker</h1>
            <p class="auth-description">Sign in to access your personal expense tracking dashboard</p>
            
            <div class="auth-features">
                <ul>
                    <li>Track daily expenses and categorize spending</li>
                    <li>Get AI-powered insights and recommendations</li>
                    <li>Visualize spending patterns over time</li>
                    <li>Strategic expense reduction planning</li>
                </ul>
            </div>
            
            <div id="g_id_signin" 
                 data-client_id="1010970898291-q8nv22u1mbbv3mjvso048dcmsip8l9ev.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false"
                 data-cancel_on_tap_outside="false"
                 data-theme="outline"
                 data-size="large"
                 data-text="signin_with"
                 data-shape="rectangular"
                 data-logo_alignment="left">
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <header>
            <div class="logo">
                <a href="/">Navajit D</a>
            </div>
            <nav>
                <ul>
                    <li><a href="#" class="sign-out-link" onclick="signOut()">Sign Out</a></li>
                </ul>
            </nav>
        </header>
        
        <div class="page-header">
            <h1 class="page-title">Expense Tracker</h1>
            <p class="page-description">Track spending fast with clarity and strategic insights.</p>
        </div>
        
        <!-- Current Stats -->
        <div class="stats-grid" id="stats-section">
            <div class="stat-card">
                <div class="stat-value" id="total-spent">--</div>
                <div class="stat-label">Total Spent This Month</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-daily">--</div>
                <div class="stat-label">Average Daily Expense</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="top-category">--</div>
                <div class="stat-label">Top Spending Category</div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-button active" data-tab="add-expense">New Expense</button>
            <button class="tab-button" data-tab="trends">Trends & Insights</button>
        </div>
        
        <!-- Add Expense Tab -->
        <div id="add-expense" class="tab-content active">
            <div class="form-container">
                <form id="expense-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expense-name">Expense Name</label>
                            <input type="text" id="expense-name" name="expenseName" required>
                        </div>
                        <div class="form-group">
                            <label for="category">Category</label>
                            <select id="category" name="category" required>
                                <option value="">Select Category</option>
                                <option value="Miscellaneous">Miscellaneous</option>
                                <option value="Bike">Bike</option>
                                <option value="Auto/Cab">Auto/Cab</option>
                                <option value="Public transport">Public transport</option>
                                <option value="Groceries">Groceries</option>
                                <option value="Eating out">Eating out</option>
                                <option value="Party">Party</option>
                                <option value="Household supplies">Household supplies</option>
                                <option value="Education">Education</option>
                                <option value="Gift">Gift</option>
                                <option value="Cinema">Cinema</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Rent/Maintenance">Rent/Maintenance</option>
                                <option value="Furniture">Furniture</option>
                                <option value="Services">Services</option>
                                <option value="Electricity">Electricity</option>
                                <option value="Internet">Internet</option>
                                <option value="Investment">Investment</option>
                                <option value="Insurance">Insurance</option>
                                <option value="Medical expenses">Medical expenses</option>
                                <option value="Flights">Flights</option>
                                <option value="Travel">Travel</option>
                                <option value="Clothes">Clothes</option>
                                <option value="Gas">Gas</option>
                                <option value="Phone">Phone</option>
                                <option value="Liquor">Liquor</option>
                                <option value="Games/Sports">Games/Sports</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="amount">Amount (â‚¹)</label>
                            <input type="number" id="amount" name="amount" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-method">Payment Method</label>
                            <select id="payment-method" name="paymentMethod" required>
                                <option value="">Select Payment Method</option>
                                <option value="Cred UPI">Cred UPI</option>
                                <option value="Credit card">Credit card</option>
                                <option value="GPay UPI">GPay UPI</option>
                                <option value="Pine Perks">Pine Perks</option>
                                <option value="Cash">Cash</option>
                                <option value="Debit card">Debit card</option>
                                <option value="Net Banking">Net Banking</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="submit">Add Expense</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="shared" name="shared" style="width: auto; margin-right: 0.5rem;">
                            Shared expense
                        </label>
                    </div>
                    
                    <div id="shared-options" class="hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="split-between">Split between (people)</label>
                                <input type="number" id="split-between" name="splitBetween" min="1" value="2">
                            </div>
                            <div class="form-group">
                                <label for="split-amount">Split Amount (â‚¹)</label>
                                <input type="number" id="split-amount" name="splitAmount" min="0" step="0.01">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <div id="message-container"></div>
        </div>
        
        <!-- Trends & Insights Tab -->
        <div id="trends" class="tab-content">
            <div class="ai-section">
                <h3 class="ai-title">ðŸ’¡ AI Expense Advisor</h3>
                <p style="margin-bottom: 1rem; color: var(--muted-color);">Ask me anything about your spending patterns, get personalized recommendations, or explore your expense data.</p>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="message ai">
                            <div class="message-content">ðŸ‘‹ Hi! I'm your AI expense advisor. I can help you analyze your spending patterns, identify areas to save money, and answer questions about your expenses. Try asking me things like:</div>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--muted-color); font-size: 0.875rem;">
                                <li>"What are my biggest expense categories this month?"</li>
                                <li>"How can I reduce my dining out expenses?"</li>
                                <li>"Show me my spending trends over the last 3 months"</li>
                                <li>"What's my average monthly grocery spending?"</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <div class="chat-input">
                            <input type="text" id="chat-message" placeholder="Ask me about your expenses..." maxlength="500">
                            <button id="send-message">Send</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Smart Insights Grid -->
            <div class="insights-grid" id="insights-grid">
                <!-- Insights will be dynamically generated here -->
            </div>
            
            <!-- Charts Container -->
            <div class="charts-container" id="charts-container">
                <!-- Charts will be rendered here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let expenses = [];
        let userEmail = null;
        
        // Google Apps Script URL
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwISgM-mNsc6fZmKki2ImDKhsePg_Ixbcku3Ofw9_feNE9OuDUEDamLylrwK5kLB7vGZg/exec";
        
        // Initialize Google Sign-In
        window.onload = function() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                google.accounts.id.initialize({
                    client_id: '1010970898291-q8nv22u1mbbv3mjvso048dcmsip8l9ev.apps.googleusercontent.com',
                    callback: handleCredentialResponse,
                    auto_select: false,
                    cancel_on_tap_outside: false
                });
                
                google.accounts.id.renderButton(
                    document.getElementById('g_id_signin'),
                    {
                        theme: 'outline',
                        size: 'large',
                        text: 'signin_with',
                        shape: 'rectangular',
                        logo_alignment: 'left'
                    }
                );
            }
        };
        
        // Handle Google Sign-In
        window.handleCredentialResponse = function(response) {
            const responsePayload = decodeJwtResponse(response.credential);
            
            if (responsePayload.email === 'navjitdebnath5@gmail.com') {
                userEmail = responsePayload.email;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                initializeApp();
            } else {
                alert('Access denied. This expense tracker is restricted to authorized users only.');
                signOut();
            }
        };
        
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }
        
        window.signOut = function() {
            userEmail = null;
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
            if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                google.accounts.id.disableAutoSelect();
            }
        };
        
        // Initialize app
        function initializeApp() {
            setupTabs();
            setupExpenseForm();
            loadExpenseData();
            setTodayDate();
            setupChatbot();
        }
        
        // Tab functionality
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    
                    // Update active states
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    button.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                    
                    // Load trends data when trends tab is activated
                    if (targetTab === 'trends') {
                        loadTrendsAndInsights();
                    }
                });
            });
        }
        
        // Set today's date
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }
        
        // Setup expense form
        function setupExpenseForm() {
            const form = document.getElementById('expense-form');
            const sharedCheckbox = document.getElementById('shared');
            const sharedOptions = document.getElementById('shared-options');
            const amountInput = document.getElementById('amount');
            const splitBetweenInput = document.getElementById('split-between');
            const splitAmountInput = document.getElementById('split-amount');
            
            // Show/hide shared options
            sharedCheckbox.addEventListener('change', () => {
                if (sharedCheckbox.checked) {
                    sharedOptions.classList.remove('hidden');
                    updateSplitAmount();
                } else {
                    sharedOptions.classList.add('hidden');
                }
            });
            
            // Auto-calculate split amount
            function updateSplitAmount() {
                const amount = parseFloat(amountInput.value) || 0;
                const splitBetween = parseInt(splitBetweenInput.value) || 2;
                if (amount > 0 && splitBetween > 0) {
                    splitAmountInput.value = (amount / splitBetween).toFixed(2);
                }
            }
            
            amountInput.addEventListener('input', updateSplitAmount);
            splitBetweenInput.addEventListener('input', updateSplitAmount);
            
            // Form submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitExpense(new FormData(form));
            });
        }
        
        // Submit expense
        async function submitExpense(formData) {
            const messageContainer = document.getElementById('message-container');
            
            try {
                const expense = {
                    expenseName: formData.get('expenseName'),
                    category: formData.get('category'),
                    amount: parseFloat(formData.get('amount')),
                    originalAmount: parseFloat(formData.get('amount')),
                    date: formData.get('date'),
                    month: new Date(formData.get('date')).toLocaleString('default', { month: 'long' }),
                    year: new Date(formData.get('date')).getFullYear(),
                    paymentMethod: formData.get('paymentMethod'),
                    shared: formData.get('shared') ? 'Yes' : 'No',
                    timeStamp: new Date().toISOString()
                };
                
                // Handle shared expense
                if (formData.get('shared')) {
                    expense.splitBetween = parseInt(formData.get('splitBetween')) || 2;
                    expense.splitAmount = parseFloat(formData.get('splitAmount')) || 0;
                    if (expense.splitAmount > 0) {
                        expense.amount = expense.splitAmount;
                    }
                }
                
                // Add billing cycle for credit card
                if (expense.paymentMethod === 'Credit card') {
                    expense.billingCycle = getBillingCycle(new Date(expense.date));
                }
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(expense)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showMessage('Expense added successfully!', 'success');
                    document.getElementById('expense-form').reset();
                    setTodayDate();
                    document.getElementById('shared-options').classList.add('hidden');
                    await loadExpenseData(); // Reload data
                } else {
                    throw new Error(result.message || 'Failed to add expense');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error adding expense: ' + error.message, 'error');
            }
        }
        
        // Show message
        function showMessage(text, type) {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-banner ${type}`;
            messageDiv.textContent = text;
            
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
        
        // Get billing cycle
        function getBillingCycle(date) {
            const day = date.getDate();
            
            if (day < 16) {
                const lastMonth = new Date(date.getFullYear(), date.getMonth() - 1, 25);
                const thisMonth = new Date(date.getFullYear(), date.getMonth(), 25);
                return `${lastMonth.toLocaleString('default', { month: 'short' })} 25 - ${thisMonth.toLocaleString('default', { month: 'short' })} 25`;
            } else {
                const thisMonth = new Date(date.getFullYear(), date.getMonth(), 25);
                const nextMonth = new Date(date.getFullYear(), date.getMonth() + 1, 25);
                return `${thisMonth.toLocaleString('default', { month: 'short' })} 25 - ${nextMonth.toLocaleString('default', { month: 'short' })} 25`;
            }
        }
        
        // Load expense data
        async function loadExpenseData() {
            try {
                const response = await fetch(APPS_SCRIPT_URL);
                const result = await response.json();
                
                if (result.data) {
                    expenses = result.data.sort((a, b) => new Date(b.date) - new Date(a.date));
                    updateStats();
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        // Update stats
        function updateStats() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const thisMonthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });
            
            // Total spent this month
            const totalSpent = thisMonthExpenses.reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);
            document.getElementById('total-spent').textContent = `â‚¹${totalSpent.toFixed(0)}`;
            
            // Average daily expense
            const daysInMonth = now.getDate();
            const avgDaily = totalSpent / daysInMonth;
            document.getElementById('avg-daily').textContent = `â‚¹${avgDaily.toFixed(0)}`;
            
            // Top category (excluding Rent/Maintenance)
            const categoryTotals = {};
            thisMonthExpenses.forEach(expense => {
                const category = expense.category;
                categoryTotals[category] = (categoryTotals[category] || 0) + parseFloat(expense.amount || 0);
            });
            
            const sortedCategories = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a);
            
            let topCategory = '--';
            if (sortedCategories.length > 0) {
                if (sortedCategories[0][0] === 'Rent/Maintenance' && sortedCategories.length > 1) {
                    topCategory = sortedCategories[1][0];
                } else {
                    topCategory = sortedCategories[0][0];
                }
            }
            
            document.getElementById('top-category').textContent = topCategory;
        }
        
        // Setup chatbot
        function setupChatbot() {
            const chatInput = document.getElementById('chat-message');
            const sendButton = document.getElementById('send-message');
            const chatMessages = document.getElementById('chat-messages');
            
            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                // Add user message
                addMessage(message, 'user');
                chatInput.value = '';
                
                // Process message and get AI response
                setTimeout(() => {
                    const response = processAIQuery(message);
                    addMessage(response, 'ai');
                }, 1000);
            }
            
            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
        
        // Add message to chat
        function addMessage(content, type) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = new Date().toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timeDiv);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Process AI query (simple rule-based for now)
        function processAIQuery(query) {
            const lowerQuery = query.toLowerCase();
            
            // Calculate current month stats
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const thisMonthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });
            
            const totalSpent = thisMonthExpenses.reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);
            
            // Category analysis
            if (lowerQuery.includes('category') || lowerQuery.includes('breakdown')) {
                const categoryTotals = {};
                thisMonthExpenses.forEach(expense => {
                    const category = expense.category;
                    categoryTotals[category] = (categoryTotals[category] || 0) + parseFloat(expense.amount || 0);
                });
                
                const sortedCategories = Object.entries(categoryTotals)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);
                
                let response = `Your top spending categories this month are:\n\n`;
                sortedCategories.forEach(([category, amount], index) => {
                    response += `${index + 1}. ${category}: â‚¹${amount.toFixed(0)}\n`;
                });
                
                return response;
            }
            
            // Dining out suggestions
            if (lowerQuery.includes('dining') || lowerQuery.includes('eating out') || lowerQuery.includes('restaurant')) {
                const diningExpenses = thisMonthExpenses.filter(expense => 
                    expense.category === 'Eating out'
                );
                const diningTotal = diningExpenses.reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);
                
                return `You've spent â‚¹${diningTotal.toFixed(0)} on dining out this month. Here are some tips to reduce this:\n\nâ€¢ Plan your meals in advance\nâ€¢ Cook more meals at home\nâ€¢ Set a weekly dining budget\nâ€¢ Choose budget-friendly restaurants\nâ€¢ Share meals or opt for lunch specials`;
            }
            
            // Spending trends
            if (lowerQuery.includes('trend') || lowerQuery.includes('pattern')) {
                const avgDailySpending = totalSpent / now.getDate();
                const projectedMonthly = avgDailySpending * 30;
                
                return `Based on your current spending pattern:\n\nâ€¢ Average daily spending: â‚¹${avgDailySpending.toFixed(0)}\nâ€¢ Projected monthly total: â‚¹${projectedMonthly.toFixed(0)}\nâ€¢ You're ${projectedMonthly > totalSpent ? 'on track' : 'ahead'} of your current pace`;
            }
            
            // Grocery spending
            if (lowerQuery.includes('grocery') || lowerQuery.includes('groceries')) {
                const groceryExpenses = thisMonthExpenses.filter(expense => 
                    expense.category === 'Groceries'
                );
                const groceryTotal = groceryExpenses.reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);
                const avgGrocerySpending = groceryTotal / groceryExpenses.length || 0;
                
                return `Your grocery spending this month: â‚¹${groceryTotal.toFixed(0)} across ${groceryExpenses.length} transactions. Average per trip: â‚¹${avgGrocerySpending.toFixed(0)}`;
            }
            
            // General help
            if (lowerQuery.includes('help') || lowerQuery.includes('what can you do')) {
                return `I can help you with:\n\nâ€¢ Analyzing your spending by category\nâ€¢ Providing tips to reduce expenses\nâ€¢ Showing spending trends and patterns\nâ€¢ Calculating averages and totals\nâ€¢ Suggesting budget optimization strategies\n\nTry asking specific questions about your expenses!`;
            }
            
            // Default response
            return `I understand you're asking about "${query}". While I'm still learning to analyze your expense data better, I can see you've spent â‚¹${totalSpent.toFixed(0)} this month across ${thisMonthExpenses.length} transactions. Is there a specific aspect of your spending you'd like me to focus on?`;
        }
        
        // Load trends and insights
        function loadTrendsAndInsights() {
            generateInsights();
            generateCharts();
        }
        
        // Generate insights
        function generateInsights() {
            const insightsGrid = document.getElementById('insights-grid');
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const thisMonthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });
            
            const lastMonthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === (currentMonth - 1 + 12) % 12 && 
                       expenseDate.getFullYear() === (currentMonth === 0 ? currentYear - 1 : currentYear);
            });
            
            const thisMonthTotal = thisMonthExpenses.reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);
            const lastMonthTotal = lastMonthExpenses.reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);
            const monthOverMonthChange = ((thisMonthTotal - lastMonthTotal) / lastMonthTotal * 100) || 0;
            
            // Category analysis
            const categoryTotals = {};
            thisMonthExpenses.forEach(expense => {
                const category = expense.category;
                categoryTotals[category] = (categoryTotals[category] || 0) + parseFloat(expense.amount || 0);
            });
            
            const topCategory = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)[0];
            
            // Generate insight cards
            const insights = [
                {
                    title: 'Month-over-Month Change',
                    value: `${monthOverMonthChange > 0 ? '+' : ''}${monthOverMonthChange.toFixed(1)}%`,
                    description: monthOverMonthChange > 0 ? 'Spending increased from last month' : 'Spending decreased from last month'
                },
                {
                    title: 'Biggest Expense Category',
                    value: topCategory ? topCategory[0] : 'N/A',
                    description: topCategory ? `â‚¹${topCategory[1].toFixed(0)} spent this month` : 'No data available'
                },
                {
                    title: 'Daily Average',
                    value: `â‚¹${(thisMonthTotal / now.getDate()).toFixed(0)}`,
                    description: `Based on ${now.getDate()} days of spending`
                },
                {
                    title: 'Transaction Count',
                    value: thisMonthExpenses.length.toString(),
                    description: 'Total transactions this month'
                }
            ];
            
            insightsGrid.innerHTML = insights.map(insight => `
                <div class="insight-card">
                    <h4 class="insight-title">${insight.title}</h4>
                    <div class="insight-value">${insight.value}</div>
                    <div class="insight-description">${insight.description}</div>
                </div>
            `).join('');
        }
        
        // Generate charts
        function generateCharts() {
            const chartsContainer = document.getElementById('charts-container');
            
            // Create container for category chart
            chartsContainer.innerHTML = `
                <div class="chart-wrapper">
                    <h4 style="margin-bottom: 1rem; font-size: 1.125rem; font-weight: 600;">Spending by Category (This Month)</h4>
                    <div id="category-chart" style="height: 400px;"></div>
                </div>
            `;
            
            // Get current month data
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const thisMonthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });
            
            // Category breakdown
            const categoryTotals = {};
            thisMonthExpenses.forEach(expense => {
                const category = expense.category;
                categoryTotals[category] = (categoryTotals[category] || 0) + parseFloat(expense.amount || 0);
            });
            
            const categories = Object.keys(categoryTotals);
            const amounts = Object.values(categoryTotals);
            
            // Create pie chart
            const pieData = [{
                values: amounts,
                labels: categories,
                type: 'pie',
                textinfo: 'label+percent',
                textposition: 'outside',
                automargin: true
            }];
            
            const pieLayout = {
                title: false,
                showlegend: true,
                legend: {
                    orientation: 'h',
                    yanchor: 'bottom',
                    y: -0.3,
                    xanchor: 'center',
                    x: 0.5
                },
                margin: { t: 20, r: 20, b: 100, l: 20 },
                font: { family: 'Inconsolata, monospace', size: 12 }
            };
            
            Plotly.newPlot('category-chart', pieData, pieLayout, { responsive: true });
        }
    </script>
</body>
</html>
