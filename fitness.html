<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>Fitness - Navajit D</title>
    
    <!-- Open Graph meta tags for thumbnail -->
    <meta property="og:title" content="Fitness Tracker - Navajit D">
    <meta property="og:description" content="Personal fitness tracking dashboard with AI-powered recommendations">
    <meta property="og:image" content="https://navajitd.github.io/assets/fitness-thumbnail.png">
    <meta property="og:url" content="https://navajitd.github.io/fitness.html">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Fitness Tracker - Navajit D">
    <meta name="twitter:description" content="Personal fitness tracking dashboard with AI-powered recommendations">
    <meta name="twitter:image" content="https://navajitd.github.io/assets/fitness-thumbnail.png">
    
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* Base Styles */
        :root {
            --text-color: #171717;
            --bg-color: #fff;
            --accent-color: #2563eb;
            --muted-color: #6b7280;
            --border-color: #e5e7eb;
            --font-sans: "Inconsolata", monospace;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html {
            font-size: 16px;
        }
        
        body {
            font-family: var(--font-sans);
            color: var(--text-color);
            background-color: var(--bg-color);
            line-height: 1.65;
            max-width: 42rem;
            margin: 0 auto;
            padding: 3rem 1.5rem;
        }
        
        a {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        p {
            margin-bottom: 1.5rem;
        }
        
        /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
        }
        
        .logo {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-color);
        }
        
        .logo a {
            color: var(--text-color);
        }
        
        .logo a:hover {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        nav ul {
            display: flex;
            gap: 1.5rem;
            list-style: none;
        }
        
        nav a {
            color: var(--text-color);
            font-size: 1rem;
        }
        
        nav a:hover {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        nav a.current {
            color: var(--accent-color);
            font-weight: 600;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--muted-color);
        }
        
        .sign-out-btn {
            color: var(--accent-color);
            cursor: pointer;
            border: none;
            background: none;
            font: inherit;
        }
        
        .sign-out-btn:hover {
            text-decoration: underline;
        }
        
        /* Authentication */
        .auth-container {
            text-align: center;
            padding: 4rem 0;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin: 2rem 0;
        }
        
        .auth-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .auth-description {
            color: var(--muted-color);
            margin-bottom: 2rem;
            font-size: 1.125rem;
        }
        
        .auth-features {
            text-align: left;
            max-width: 300px;
            margin: 0 auto 2rem;
        }
        
        .auth-features ul {
            list-style: none;
            padding: 0;
        }
        
        .auth-features li {
            padding: 0.5rem 0;
            position: relative;
            padding-left: 1.5rem;
        }
        
        .auth-features li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: var(--success-color);
            font-weight: bold;
        }
        
        #g_id_signin {
            display: inline-block;
            margin: 0 auto;
        }
        
        .restricted-access {
            background: #fef2f2;
            border: 1px solid #fecaca;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            color: #dc2626;
            font-size: 0.875rem;
        }
        
        /* Page Header */
        .page-header {
            margin-bottom: 3rem;
        }
        
        .page-title {
            font-size: 2rem;
            line-height: 1.3;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .page-description {
            font-size: 1.125rem;
            color: var(--muted-color);
        }
        
        /* Section Styles */
        section {
            margin-bottom: 4rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            letter-spacing: 0.05em;
        }
        
        /* Form Styles */
        .form-container {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        input[type="number"],
        input[type="date"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: inherit;
            font-size: 1rem;
        }
        
        input[type="number"]:focus,
        input[type="date"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background: #1d4ed8;
        }
        
        button:disabled {
            background: var(--muted-color);
            cursor: not-allowed;
        }
        
        /* Filter Buttons */
        .filter-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.875rem;
            color: var(--text-color);
        }
        
        .filter-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        /* Charts */
        .chart-container {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: white;
        }
        
        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            padding: 1.5rem;
            background: #f9fafb;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--muted-color);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* AI Agent - Simple container for iframe */
        .ai-section {
            background: #f0f9ff;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e0f2fe;
        }
        
        .chat-container {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
            overflow: hidden;
            min-height: 700px;
        }
        
        .recommendations {
            margin-top: 1rem;
        }
        
        .recommendation-item {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--accent-color);
        }
        
        .recommendation-time {
            font-size: 0.75rem;
            color: var(--muted-color);
            margin-bottom: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Responsive */
        @media (max-width: 640px) {
            body {
                padding: 2rem 1rem;
            }
            
            header {
                flex-direction: column;
                gap: 1rem;
            }
            
            nav ul {
                gap: 1rem;
            }
            
            .page-title {
                font-size: 1.75rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .filter-controls {
                flex-wrap: wrap;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Hidden class */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="auth-screen">
        <!-- Keep the navigation even on auth screen -->
        <header>
            <div class="logo">
                <a href="/">Navajit D</a>
            </div>
            <nav>
                <ul>
                    <li><a href="/#projects">Projects</a></li>
                    <li><a href="/blog">Blog</a></li>
                    <li><a href="/#experience">Experience</a></li>
                    <li><a href="/fitness.html" class="current">Fitness</a></li>
                    <li><a href="mailto:navajit@example.com">Contact</a></li>
                </ul>
            </nav>
        </header>
        
        <div class="auth-container">
            <h1 class="auth-title">Fitness Tracking Dashboard</h1>
            <p class="auth-description">Sign in to access your personal fitness data and AI coach</p>
            
            <div class="auth-features">
                <ul>
                    <li>Track weight and BMI over time</li>
                    <li>Visualize progress with interactive charts</li>
                    <li>Get AI-powered fitness recommendations</li>
                    <li>Secure data storage</li>
                </ul>
            </div>
            
            <div id="g_id_signin" 
                 data-client_id="1010970898291-q8nv22u1mbbv3mjvso048dcmsip8l9ev.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false"
                 data-cancel_on_tap_outside="false"
                 data-theme="outline"
                 data-size="large"
                 data-text="signin_with"
                 data-shape="rectangular"
                 data-logo_alignment="left">
            </div>
            
            <!-- Fallback sign-in button if Google doesn't load -->
            <button id="fallback-signin" class="hidden" onclick="initializeGoogleSignIn()" 
                    style="background: #4285f4; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; margin: 0 auto;">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="white" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="white" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="white" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="white" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <header>
            <div class="logo">
                <a href="/">Navajit D</a>
            </div>
            <nav>
                <ul>
                    <li><a href="/#projects">Projects</a></li>
                    <li><a href="/blog">Blog</a></li>
                    <li><a href="/#experience">Experience</a></li>
                    <li><a href="/fitness.html" class="current">Fitness</a></li>
                    <li><a href="mailto:navajit@example.com">Contact</a></li>
                </ul>
            </nav>
            <div class="user-info">
                <span id="user-email"></span>
                <button class="sign-out-btn" onclick="signOut()">Sign Out</button>
            </div>
        </header>
        
        <div class="page-header">
            <h1 class="page-title">Fitness Tracking</h1>
            <p class="page-description">Track your weight, BMI, and health metrics over time.</p>
        </div>
        
        <!-- Data Entry -->
        <section>
            <h2 class="section-title">Log New Entry</h2>
            <div class="form-container">
                <form id="fitness-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label for="weight">Weight (kg)</label>
                            <input type="number" id="weight" name="weight" step="0.1" min="30" max="300" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="height">Height (cm)</label>
                            <input type="number" id="height" name="height" step="0.1" min="100" max="250" required>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="submit">Add Entry</button>
                        </div>
                    </div>
                </form>
            </div>
        </section>
        
        <!-- Current Stats -->
        <section>
            <h2 class="section-title">Current Stats</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="current-weight">--</div>
                    <div class="stat-label">Current Weight (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="current-bmi">--</div>
                    <div class="stat-label">Current BMI</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-entries">--</div>
                    <div class="stat-label">Total Entries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="weight-change">--</div>
                    <div class="stat-label">30-Day Change (kg)</div>
                </div>
            </div>
        </section>
        
        <!-- Charts -->
        <section>
            <h2 class="section-title">Progress Charts</h2>
            <div class="filter-controls">
                <button class="filter-btn active" data-filter="weekly">Weekly</button>
                <button class="filter-btn" data-filter="monthly">Monthly</button>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Weight Progress</h3>
                <div id="weight-chart"></div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">BMI Progress</h3>
                <div id="bmi-chart"></div>
            </div>
        </section>
        
        <!-- AI Agent -->
        <section>
            <h2 class="section-title">AI Fitness Coach</h2>
            <div class="ai-section">
                <p>Chat with your AI fitness coach for personalized recommendations based on your progress data.</p>
                
                <!-- Chatbase AI Agent -->
                <div class="chat-container">
                    <iframe
                        src="https://www.chatbase.co/chatbot-iframe/6PsfEElX5kLoAlV6eMQzw"
                        width="100%"
                        style="height: 100%; min-height: 700px; border: none; border-radius: 8px;"
                        frameborder="0"
                        title="AI Fitness Coach">
                    </iframe>
                </div>
                
                <div class="recommendations">
                    <h3 style="margin-bottom: 1rem; font-size: 1.125rem; font-weight: 600;">Quick Tips</h3>
                    <div id="recommendations-list">
                        <div class="recommendation-item">
                            <div class="recommendation-time">Daily Reminder</div>
                            <div>💡 Ask your AI coach about your current BMI trends and weight goals!</div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-time">Pro Tip</div>
                            <div>🏋️ Upload your latest fitness data before chatting for more personalized advice.</div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-time">Suggestion</div>
                            <div>📈 Ask about workout routines tailored to your current fitness level.</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- ElevenLabs AI Agent removed -->
    <!-- <elevenlabs-convai agent-id="agent_01jvkdtzphetdtm6r9vf3122c0"></elevenlabs-convai>
    <script src="https://elevenlabs.io/convai-widget/index.js" async type="text/javascript"></script> -->

    <script>
        // Global variables
        let fitnessData = [];
        let currentFilter = 'weekly';
        let userEmail = null;
        
        // Initialize Google Sign-In when the page loads
        window.onload = function() {
            // Check if Google Identity Services loaded
            if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                google.accounts.id.initialize({
                    client_id: '1010970898291-q8nv22u1mbbv3mjvso048dcmsip8l9ev.apps.googleusercontent.com',
                    callback: handleCredentialResponse,
                    auto_select: false,
                    cancel_on_tap_outside: false
                });
                
                // Render the button
                google.accounts.id.renderButton(
                    document.getElementById('g_id_signin'),
                    {
                        theme: 'outline',
                        size: 'large',
                        text: 'signin_with',
                        shape: 'rectangular',
                        logo_alignment: 'left'
                    }
                );
            } else {
                // Show fallback button if Google didn't load
                document.getElementById('fallback-signin').classList.remove('hidden');
            }
        };
        
        // Fallback function to try initializing Google Sign-In
        function initializeGoogleSignIn() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                google.accounts.id.initialize({
                    client_id: '1010970898291-q8nv22u1mbbv3mjvso048dcmsip8l9ev.apps.googleusercontent.com',
                    callback: handleCredentialResponse
                });
                google.accounts.id.prompt();
            } else {
                alert('Google Sign-In is not available. Please check your internet connection and try again.');
            }
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadStoredData();
            updateCurrentStats();
            updateCharts();
            setupForm();
            setupFilters();
            setTodayDate();
        });
        
        // Google Sign-In
        window.handleCredentialResponse = function(response) {
            const responsePayload = decodeJwtResponse(response.credential);
            
            // Check if the email matches the allowed email
            if (responsePayload.email === 'navjitdebnath5@gmail.com') {
                userEmail = responsePayload.email;
                document.getElementById('user-email').textContent = responsePayload.email;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                loadStoredData();
                updateCurrentStats();
                updateCharts();
                loadDailyRecommendations();
            } else {
                alert('Access denied. This fitness tracker is restricted to authorized users only.');
                signOut();
            }
        };
        
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }
        
        window.signOut = function() {
            userEmail = null;
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
            if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                google.accounts.id.disableAutoSelect();
            }
        };
        
        // Load data from localStorage
        function loadStoredData() {
            const stored = localStorage.getItem('fitnessData');
            if (stored) {
                fitnessData = JSON.parse(stored);
                // Sort by date
                fitnessData.sort((a, b) => new Date(a.date) - new Date(b.date));
            }
        }
        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('fitnessData', JSON.stringify(fitnessData));
        }
        
        // Set today's date as default
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }
        
        // Setup form submission
        function setupForm() {
            document.getElementById('fitness-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const entry = {
                    date: formData.get('date'),
                    weight: parseFloat(formData.get('weight')),
                    height: parseFloat(formData.get('height')),
                    bmi: calculateBMI(parseFloat(formData.get('weight')), parseFloat(formData.get('height')))
                };
                
                // Check if entry for this date already exists
                const existingIndex = fitnessData.findIndex(item => item.date === entry.date);
                if (existingIndex >= 0) {
                    if (confirm('An entry for this date already exists. Do you want to update it?')) {
                        fitnessData[existingIndex] = entry;
                    } else {
                        return;
                    }
                } else {
                    fitnessData.push(entry);
                }
                
                // Sort by date
                fitnessData.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                saveData();
                updateCurrentStats();
                updateCharts();
                
                // Clear form except date
                document.getElementById('weight').value = '';
                document.getElementById('height').value = '';
                
                alert('Entry added successfully!');
            });
        }
        
        // Calculate BMI
        function calculateBMI(weight, height) {
            return weight / Math.pow(height / 100, 2);
        }
        
        // Setup filter buttons
        function setupFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    updateCharts();
                });
            });
        }
        
        // Filter data based on current filter
        function getFilteredData() {
            if (fitnessData.length === 0) return [];
            
            const now = new Date();
            let startDate;
            
            switch (currentFilter) {
                case 'weekly':
                    startDate = new Date(now.getTime() - (12 * 7 * 24 * 60 * 60 * 1000)); // Last 12 weeks
                    break;
                case 'monthly':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 11, 1); // Last 12 months
                    break;
                default:
                    return fitnessData;
            }
            
            return fitnessData.filter(entry => new Date(entry.date) >= startDate);
        }
        
        // Update current stats
        function updateCurrentStats() {
            if (fitnessData.length === 0) {
                document.getElementById('current-weight').textContent = '--';
                document.getElementById('current-bmi').textContent = '--';
                document.getElementById('total-entries').textContent = '0';
                document.getElementById('weight-change').textContent = '--';
                return;
            }
            
            const latest = fitnessData[fitnessData.length - 1];
            document.getElementById('current-weight').textContent = latest.weight.toFixed(1);
            document.getElementById('current-bmi').textContent = latest.bmi.toFixed(1);
            document.getElementById('total-entries').textContent = fitnessData.length;
            
            // Calculate 30-day change
            const thirtyDaysAgo = new Date(Date.now() - (30 * 24 * 60 * 60 * 1000));
            const recentEntries = fitnessData.filter(entry => new Date(entry.date) > thirtyDaysAgo);
            
            if (recentEntries.length >= 2) {
                const firstWeight = recentEntries[0].weight;
                const lastWeight = recentEntries[recentEntries.length - 1].weight;
                const change = lastWeight - firstWeight;
                const changeText = change > 0 ? `+${change.toFixed(1)}` : change.toFixed(1);
                document.getElementById('weight-change').textContent = changeText;
            } else {
                document.getElementById('weight-change').textContent = '--';
            }
        }
        
        // Update charts
        function updateCharts() {
            const filteredData = getFilteredData();
            
            if (filteredData.length === 0) {
                document.getElementById('weight-chart').innerHTML = '<p style="text-align: center; color: var(--muted-color);">No data available</p>';
                document.getElementById('bmi-chart').innerHTML = '<p style="text-align: center; color: var(--muted-color);">No data available</p>';
                return;
            }
            
            // Group data by week or month based on filter
            let groupedData;
            if (currentFilter === 'weekly') {
                groupedData = groupDataByWeek(filteredData);
            } else {
                groupedData = groupDataByMonth(filteredData);
            }
            
            // Prepare data for charts
            const labels = Object.keys(groupedData);
            const weights = labels.map(label => groupedData[label].weight);
            const bmis = labels.map(label => groupedData[label].bmi);
            
            // Weight chart
            const weightTrace = {
                x: labels,
                y: weights,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#2563eb', width: 3 },
                marker: { color: '#2563eb', size: 8 },
                name: 'Weight (kg)'
            };
            
            const weightLayout = {
                title: false,
                xaxis: { 
                    title: currentFilter === 'weekly' ? 'Week' : 'Month',
                    tickangle: -45
                },
                yaxis: { title: 'Weight (kg)' },
                margin: { t: 20, r: 20, b: 60, l: 50 },
                height: 400,
                font: { family: 'Inconsolata, monospace' }
            };
            
            Plotly.newPlot('weight-chart', [weightTrace], weightLayout, { responsive: true });
            
            // BMI chart with reference lines
            const bmiTrace = {
                x: labels,
                y: bmis,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#10b981', width: 3 },
                marker: { color: '#10b981', size: 8 },
                name: 'BMI'
            };
            
            // BMI reference lines
            const underweightLine = {
                x: labels,
                y: Array(labels.length).fill(18.5),
                type: 'scatter',
                mode: 'lines',
                line: { color: '#6b7280', width: 1, dash: 'dash' },
                name: 'Underweight (18.5)',
                showlegend: false
            };
            
            const overweightLine = {
                x: labels,
                y: Array(labels.length).fill(25),
                type: 'scatter',
                mode: 'lines',
                line: { color: '#f59e0b', width: 1, dash: 'dash' },
                name: 'Overweight (25)',
                showlegend: false
            };
            
            const obeseLine = {
                x: labels,
                y: Array(labels.length).fill(30),
                type: 'scatter',
                mode: 'lines',
                line: { color: '#ef4444', width: 1, dash: 'dash' },
                name: 'Obese (30)',
                showlegend: false
            };
            
            const bmiLayout = {
                title: false,
                xaxis: { 
                    title: currentFilter === 'weekly' ? 'Week' : 'Month',
                    tickangle: -45
                },
                yaxis: { title: 'BMI' },
                margin: { t: 20, r: 20, b: 60, l: 50 },
                height: 400,
                font: { family: 'Inconsolata, monospace' },
                annotations: [
                    {
                        x: labels[Math.floor(labels.length / 2)],
                        y: 18.5,
                        text: 'Underweight',
                        showarrow: false,
                        font: { size: 10, color: '#6b7280' },
                        yanchor: 'bottom'
                    },
                    {
                        x: labels[Math.floor(labels.length / 2)],
                        y: 25,
                        text: 'Overweight',
                        showarrow: false,
                        font: { size: 10, color: '#f59e0b' },
                        yanchor: 'bottom'
                    },
                    {
                        x: labels[Math.floor(labels.length / 2)],
                        y: 30,
                        text: 'Obese',
                        showarrow: false,
                        font: { size: 10, color: '#ef4444' },
                        yanchor: 'bottom'
                    }
                ]
            };
            
            Plotly.newPlot('bmi-chart', [bmiTrace, underweightLine, overweightLine, obeseLine], bmiLayout, { responsive: true });
        }
        
        // Group data by week
        function groupDataByWeek(data) {
            const grouped = {};
            
            data.forEach(entry => {
                const date = new Date(entry.date);
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - date.getDay());
                const weekKey = weekStart.toISOString().split('T')[0];
                
                if (!grouped[weekKey] || new Date(entry.date) > new Date(grouped[weekKey].date)) {
                    grouped[weekKey] = entry;
                }
            });
            
            // Sort by week
            const sortedKeys = Object.keys(grouped).sort();
            const result = {};
            sortedKeys.forEach(key => {
                const date = new Date(key);
                const weekLabel = `${date.getFullYear()}-W${Math.ceil((date.getTime() - new Date(date.getFullYear(), 0, 1).getTime()) / (7 * 24 * 60 * 60 * 1000))}`;
                result[weekLabel] = grouped[key];
            });
            
            return result;
        }
        
        // Group data by month
        function groupDataByMonth(data) {
            const grouped = {};
            
            data.forEach(entry => {
                const date = new Date(entry.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!grouped[monthKey] || new Date(entry.date) > new Date(grouped[monthKey].date)) {
                    grouped[monthKey] = entry;
                }
            });
            
            return grouped;
        }
        
        // AI Agent integration
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Disable send button and show typing indicator
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = true;
            showTypingIndicator();
            
            try {
                // Get AI response (using local mock for now)
                const response = await getAIResponse(message);
                
                // Remove typing indicator and add AI response
                hideTypingIndicator();
                addChatMessage(response, 'ai');
                
                // Convert to speech if voice is enabled
                if (voiceEnabled) {
                    speakText(response);
                }
                
                // Add to recommendations if it's a key insight
                if (response.toLowerCase().includes('recommend') || response.toLowerCase().includes('suggest')) {
                    addRecommendation(response);
                }
            } catch (error) {
                hideTypingIndicator();
                addChatMessage("I'm sorry, I encountered an error. Please try again.", 'ai');
                console.error('AI Chat Error:', error);
            } finally {
                sendButton.disabled = false;
            }
        }
        
        function addChatMessage(content, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${formatMessageContent(content)}
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function formatMessageContent(content) {
            // Convert markdown-like formatting to HTML
            content = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n- (.*?)(?=\n|$)/g, '\n<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                .replace(/\n/g, '<br>');
            
            return content;
        }
        
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai-message';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <span>AI is thinking</span>
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // Mock AI responses (replace with actual AI service)
        async function getAIResponse(message) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
            
            const latestStats = getCurrentStats();
            const userMessage = message.toLowerCase();
            
            // Context-aware responses based on user's fitness data
            if (userMessage.includes('weight') || userMessage.includes('lost') || userMessage.includes('gained')) {
                if (latestStats.weightChange !== '--') {
                    const change = parseFloat(latestStats.weightChange);
                    if (change < 0) {
                        return `Great job! You've lost ${Math.abs(change).toFixed(1)}kg in the last 30 days. Keep up the excellent work! Consider maintaining your current routine and ensure you're getting adequate protein (aim for 1.6-2.2g per kg of body weight).`;
                    } else if (change > 0) {
                        return `I notice you've gained ${change.toFixed(1)}kg recently. This could be muscle gain if you're strength training, or we might need to adjust your nutrition. Are you following a specific workout routine? I'd recommend tracking your measurements alongside weight.`;
                    } else {
                        return `Your weight has been stable, which is great for maintenance! If your goal is to lose or gain weight, we might need to adjust your caloric intake by about 300-500 calories per day.`;
                    }
                }
                return "I'd love to help with your weight goals! First, let me know what you're aiming for - weight loss, gain, or maintenance?";
            }
            
            if (userMessage.includes('bmi')) {
                if (latestStats.currentBMI !== '--') {
                    const bmi = parseFloat(latestStats.currentBMI);
                    if (bmi < 18.5) {
                        return `Your current BMI is ${bmi.toFixed(1)}, which falls in the underweight category. I recommend focusing on **strength training** and **increasing caloric intake** with nutrient-dense foods. Consider consulting with a nutritionist for a personalized meal plan.`;
                    } else if (bmi >= 18.5 && bmi < 25) {
                        return `Excellent! Your BMI of ${bmi.toFixed(1)} is in the healthy range. Focus on **maintaining your current lifestyle** with regular exercise and balanced nutrition. Consider adding variety to your workouts to prevent plateaus.`;
                    } else if (bmi >= 25 && bmi < 30) {
                        return `Your BMI is ${bmi.toFixed(1)}, which is in the overweight range. I recommend a combination of **cardio and strength training** along with a moderate caloric deficit. Aim for 150-300 minutes of moderate exercise per week.`;
                    } else {
                        return `Your BMI indicates you might benefit from a structured weight management approach. I strongly recommend consulting with healthcare professionals for a comprehensive plan that includes nutrition, exercise, and lifestyle modifications.`;
                    }
                }
                return "I don't have your current BMI data yet. Once you log your weight and height, I can provide personalized BMI guidance!";
            }
            
            if (userMessage.includes('workout') || userMessage.includes('exercise') || userMessage.includes('routine')) {
                return `Here's a balanced weekly routine I recommend:

**Monday & Thursday**: Upper Body Strength
- Push-ups or chest press: 3 sets of 8-12 reps
- Rows or pull-ups: 3 sets of 8-12 reps
- Shoulder press: 3 sets of 8-12 reps

**Tuesday & Friday**: Lower Body Strength
- Squats: 3 sets of 12-15 reps
- Lunges: 3 sets of 10 per leg
- Deadlifts: 3 sets of 8-10 reps

**Wednesday**: Cardio
- 30-45 minutes of moderate cardio (walking, cycling, swimming)

**Saturday**: Active recovery (yoga, light walking)
**Sunday**: Rest

Start with weights you can handle comfortably and gradually increase. Listen to your body!`;
            }
            
            if (userMessage.includes('nutrition') || userMessage.includes('diet') || userMessage.includes('eat')) {
                return `Here are my key nutrition recommendations:

**Macronutrient Balance**:
- Protein: 25-30% of calories (crucial for muscle maintenance)
- Carbs: 40-50% (focus on complex carbs)
- Fats: 20-25% (healthy fats like nuts, avocado, olive oil)

**Daily Habits**:
- Eat protein with every meal
- Fill half your plate with vegetables
- Stay hydrated (aim for 8-10 glasses of water)
- Eat slowly and mindfully

**Timing**:
- Eat a protein-rich breakfast within 1 hour of waking
- Have your last meal 2-3 hours before bed

Would you like specific meal ideas or help with portion sizes?`;
            }
            
            if (userMessage.includes('motivation') || userMessage.includes('stuck') || userMessage.includes('plateau')) {
                return `I understand how frustrating plateaus can be! Here's how to break through:

**Shake up your routine**:
- Try new exercises every 4-6 weeks
- Increase intensity or duration gradually
- Add variety (if you usually do cardio, try strength training)

**Track everything**:
- Take body measurements, not just weight
- Monitor energy levels and sleep quality
- Progress photos can be very motivating

**Remember**:
- Plateaus are normal and temporary
- Small changes compound over time
- Celebrate non-scale victories (strength gains, better sleep, mood improvements)

You've got this! Consistency beats perfection every time.`;
            }
            
            // Default responses for general queries
            const responses = [
                "Based on your fitness journey, I'd recommend focusing on consistency over perfection. What specific area would you like to work on?",
                "Let's talk about your goals! Are you looking to lose weight, build muscle, improve endurance, or maintain your current fitness level?",
                "I notice you've been tracking your progress - that's fantastic! Consistent monitoring is key to long-term success. How are you feeling about your current routine?",
                "Fitness is a journey, not a destination. What's one small change you could make this week to move closer to your goals?",
                "I'd love to help you optimize your fitness routine! Could you tell me about your current exercise habits and any challenges you're facing?"
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        function getCurrentStats() {
            return {
                currentWeight: document.getElementById('current-weight').textContent,
                currentBMI: document.getElementById('current-bmi').textContent,
                totalEntries: document.getElementById('total-entries').textContent,
                weightChange: document.getElementById('weight-change').textContent
            };
        }
        
        // Text-to-Speech functionality
        function speakText(text) {
            // Stop any current speech
            if (currentSpeech) {
                speechSynthesis.cancel();
            }
            
            // Clean text for better speech
            const cleanText = text
                .replace(/\*\*(.*?)\*\*/g, '$1')
                .replace(/\*(.*?)\*/g, '$1')
                .replace(/[•\-]\s*/g, '');
            
            if ('speechSynthesis' in window) {
                currentSpeech = new SpeechSynthesisUtterance(cleanText);
                currentSpeech.rate = 0.9;
                currentSpeech.pitch = 1;
                currentSpeech.volume = 0.8;
                
                // Try to use a more natural voice
                const voices = speechSynthesis.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.name.includes('Google') || 
                    voice.name.includes('Microsoft') ||
                    voice.lang.includes('en')
                );
                if (preferredVoice) {
                    currentSpeech.voice = preferredVoice;
                }
                
                speechSynthesis.speak(currentSpeech);
            }
        }
        
        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            const voiceIcon = document.getElementById('voice-icon');
            const voiceButton = document.querySelector('.voice-toggle');
            
            if (voiceEnabled) {
                voiceIcon.textContent = '🔊';
                voiceButton.classList.add('enabled');
                voiceButton.title = 'Voice responses enabled - click to disable';
            } else {
                voiceIcon.textContent = '🔇';
                voiceButton.classList.remove('enabled');
                voiceButton.title = 'Voice responses disabled - click to enable';
                // Stop any current speech
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
            }
        }
        
        function clearChat() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="message ai-message">
                    <div class="message-content">
                        <p>Hello! I'm your AI fitness coach. I can help you with:</p>
                        <ul>
                            <li>Analyzing your weight and BMI trends</li>
                            <li>Providing personalized fitness recommendations</li>
                            <li>Suggesting workout routines</li>
                            <li>Discussing nutrition and healthy habits</li>
                        </ul>
                        <p>What would you like to know about your fitness journey?</p>
                    </div>
                </div>
            `;
        }
        
        // Setup chat input handling
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            // Initialize voice toggle state
            const voiceButton = document.querySelector('.voice-toggle');
            if (voiceButton && voiceEnabled) {
                voiceButton.classList.add('enabled');
            }
        });
        
        // Add recommendation
        function addRecommendation(text) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            const recommendationsContainer = document.getElementById('recommendations-list');
            
            // Clear the "no recommendations" message if it exists
            if (recommendationsContainer.innerHTML.includes('No recommendations yet')) {
                recommendationsContainer.innerHTML = '';
            }
            
            const recommendationElement = document.createElement('div');
            recommendationElement.className = 'recommendation-item';
            recommendationElement.innerHTML = `
                <div class="recommendation-time">${timeString}</div>
                <div>${text}</div>
            `;
            
            recommendationsContainer.appendChild(recommendationElement);
            
            // Save recommendations to localStorage
            const recommendations = JSON.parse(localStorage.getItem('dailyRecommendations') || '[]');
            recommendations.push({
                time: now.toISOString(),
                text: text
            });
            localStorage.setItem('dailyRecommendations', JSON.stringify(recommendations));
        }
        
        // Load daily recommendations
        function loadDailyRecommendations() {
            const today = new Date().toDateString();
            const recommendations = JSON.parse(localStorage.getItem('dailyRecommendations') || '[]');
            const todayRecommendations = recommendations.filter(rec => 
                new Date(rec.time).toDateString() === today
            );
            
            const container = document.getElementById('recommendations-list');
            if (todayRecommendations.length === 0) {
                container.innerHTML = '<p style="color: var(--muted-color); font-size: 0.875rem;">No recommendations yet. Talk to your AI coach to get started!</p>';
            } else {
                container.innerHTML = '';
                todayRecommendations.forEach(rec => {
                    const time = new Date(rec.time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const element = document.createElement('div');
                    element.className = 'recommendation-item';
                    element.innerHTML = `
                        <div class="recommendation-time">${time}</div>
                        <div>${rec.text}</div>
                    `;
                    container.appendChild(element);
                });
            }
        }
    </script>
</body>
</html>
