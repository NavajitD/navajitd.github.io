<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>Fitness - Navajit D</title>
    
    <!-- Open Graph meta tags for thumbnail -->
    <meta property="og:title" content="Fitness Tracker - Navajit D">
    <meta property="og:description" content="Personal fitness tracking dashboard with AI-powered recommendations">
    <meta property="og:image" content="https://navajitd.github.io/assets/fitness-thumbnail.png">
    <meta property="og:url" content="https://navajitd.github.io/fitness.html">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Fitness Tracker - Navajit D">
    <meta name="twitter:description" content="Personal fitness tracking dashboard with AI-powered recommendations">
    <meta name="twitter:image" content="https://navajitd.github.io/assets/fitness-thumbnail.png">
    
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* Base Styles */
        :root {
            --text-color: #171717;
            --bg-color: #fff;
            --accent-color: #2563eb;
            --muted-color: #6b7280;
            --border-color: #e5e7eb;
            --font-sans: "Inconsolata", monospace;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html {
            font-size: 16px;
        }
        
        body {
            font-family: var(--font-sans);
            color: var(--text-color);
            background-color: var(--bg-color);
            line-height: 1.65;
            max-width: 42rem;
            margin: 0 auto;
            padding: 3rem 1.5rem;
        }
        
        a {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        p {
            margin-bottom: 1.5rem;
        }
        
        /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
        }
        
        .logo {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-color);
        }
        
        .logo a {
            color: var(--text-color);
        }
        
        .logo a:hover {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        nav ul {
            display: flex;
            gap: 1.5rem;
            list-style: none;
        }
        
        nav a {
            color: var(--text-color);
            font-size: 1rem;
        }
        
        nav a:hover {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        nav a.current {
            color: var(--accent-color);
            font-weight: 600;
        }
        
        /* Modified: Removed the user-info div and integrated sign-out into nav */
        .sign-out-link {
            color: var(--text-color);
            cursor: pointer;
            border: none;
            background: none;
            font: inherit;
            font-size: 1rem;
            padding: 0;
        }
        
        .sign-out-link:hover {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        /* Authentication */
        .auth-container {
            text-align: center;
            padding: 4rem 0;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin: 2rem 0;
        }
        
        .auth-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .auth-description {
            color: var(--muted-color);
            margin-bottom: 2rem;
            font-size: 1.125rem;
        }
        
        .auth-features {
            text-align: left;
            max-width: 300px;
            margin: 0 auto 2rem;
        }
        
        .auth-features ul {
            list-style: none;
            padding: 0;
        }
        
        .auth-features li {
            padding: 0.5rem 0;
            position: relative;
            padding-left: 1.5rem;
        }
        
        .auth-features li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: var(--success-color);
            font-weight: bold;
        }
        
        #g_id_signin {
            display: inline-block;
            margin: 0 auto;
        }
        
        .restricted-access {
            background: #fef2f2;
            border: 1px solid #fecaca;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            color: #dc2626;
            font-size: 0.875rem;
        }
        
        /* Page Header */
        .page-header {
            margin-bottom: 3rem;
        }
        
        .page-title {
            font-size: 2rem;
            line-height: 1.3;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .page-description {
            font-size: 1.125rem;
            color: var(--muted-color);
        }
        
        /* Section Styles */
        section {
            margin-bottom: 4rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            letter-spacing: 0.05em;
        }
        
        /* Form Styles - Modified to reduce bottom padding */
        .form-container {
            background: #f9fafb;
            padding: 1.5rem 1.5rem 1rem; /* Reduced bottom padding */
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }
        
        .form-group {
            margin-bottom: 1rem; /* Reduced from 1.5rem */
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        input[type="number"],
        input[type="date"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: inherit;
            font-size: 1rem;
        }
        
        input[type="number"]:focus,
        input[type="date"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background: #1d4ed8;
        }
        
        button:disabled {
            background: var(--muted-color);
            cursor: not-allowed;
        }
        
        /* Filter Buttons */
        .filter-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.875rem;
            color: var(--text-color);
        }
        
        .filter-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        /* Modified: Charts in side-by-side layout and center-aligned */
        .charts-row {
            display: flex;
            gap: 1rem;
            margin: 0 auto 1.5rem;
            justify-content: center;
        }
        
        .chart-container {
            flex: 1;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: white;
        }
        
        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        /* Modified: Stats - single row with only 3 stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            padding: 1.5rem;
            background: #f9fafb;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--muted-color);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* AI Agent - More landscape oriented */
        .ai-section {
            background: #f0f9ff;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e0f2fe;
        }
        
        /* Modified: More landscape oriented chat container */
        .chat-container {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
            overflow: hidden;
            min-height: 500px; /* Reduced height for more landscape orientation */
        }
        
        /* Voice input UI */
        .voice-controls {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
            align-items: center;
        }
        
        .voice-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
        }
        
        .voice-btn:hover {
            background: #1d4ed8;
        }
        
        .voice-btn.listening {
            animation: pulse 1.5s infinite;
            background: #ef4444;
        }
        
        .voice-status {
            font-size: 0.875rem;
            color: var(--muted-color);
            flex: 1;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
        
        .recommendations {
            margin-top: 1rem;
        }
        
        .recommendation-item {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--accent-color);
        }
        
        .recommendation-time {
            font-size: 0.75rem;
            color: var(--muted-color);
            margin-bottom: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .charts-row {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 640px) {
            body {
                padding: 2rem 1rem;
            }
            
            header {
                flex-direction: column;
                gap: 1rem;
            }
            
            nav ul {
                gap: 1rem;
            }
            
            .page-title {
                font-size: 1.75rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .filter-controls {
                flex-wrap: wrap;
            }
        }
        
        /* Hidden class */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="auth-screen">
        <!-- Keep the navigation even on auth screen -->
        <header>
            <div class="logo">
                <a href="/">Navajit D</a>
            </div>
            <nav>
                <ul>
                    <li><a href="/#projects">Projects</a></li>
                    <li><a href="/blog">Blog</a></li>
                    <li><a href="/#experience">Experience</a></li>
                    <li><a href="/fitness.html" class="current">Fitness</a></li>
                    <li><a href="mailto:navajit@example.com">Contact</a></li>
                </ul>
            </nav>
        </header>
        
        <div class="auth-container">
            <h1 class="auth-title">Fitness Tracking Dashboard</h1>
            <p class="auth-description">Sign in to access your personal fitness data and AI coach</p>
            
            <div class="auth-features">
                <ul>
                    <li>Track weight and BMI over time</li>
                    <li>Visualize progress with interactive charts</li>
                    <li>Get AI-powered fitness recommendations</li>
                    <li>Secure data storage</li>
                </ul>
            </div>
            
            <div id="g_id_signin" 
                 data-client_id="1010970898291-q8nv22u1mbbv3mjvso048dcmsip8l9ev.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false"
                 data-cancel_on_tap_outside="false"
                 data-theme="outline"
                 data-size="large"
                 data-text="signin_with"
                 data-shape="rectangular"
                 data-logo_alignment="left">
            </div>
            
            <!-- Fallback sign-in button if Google doesn't load -->
            <button id="fallback-signin" class="hidden" onclick="initializeGoogleSignIn()" 
                    style="background: #4285f4; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; margin: 0 auto;">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="white" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="white" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="white" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="white" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <header>
            <div class="logo">
                <a href="/">Navajit D</a>
            </div>
            <nav>
                <ul>
                    <li><a href="/#projects">Projects</a></li>
                    <li><a href="/blog">Blog</a></li>
                    <li><a href="/#experience">Experience</a></li>
                    <li><a href="/fitness.html" class="current">Fitness</a></li>
                    <li><a href="mailto:navajit@example.com">Contact</a></li>
                    <!-- Modified: Added sign out as a nav link -->
                    <li><a href="#" class="sign-out-link" onclick="signOut()">Sign Out</a></li>
                </ul>
            </nav>
        </header>
        
        <div class="page-header">
            <h1 class="page-title">Fitness Tracking</h1>
            <p class="page-description">Track your weight, BMI, and health metrics over time.</p>
        </div>
        
        <!-- Data Entry - Modified with reduced padding -->
        <section>
            <h2 class="section-title">Log New Entry</h2>
            <div class="form-container">
                <form id="fitness-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label for="weight">Weight (kg)</label>
                            <input type="number" id="weight" name="weight" step="0.1" min="30" max="300" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="height">Height (cm)</label>
                            <input type="number" id="height" name="height" step="0.1" min="100" max="250" required>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="submit">Add Entry</button>
                        </div>
                    </div>
                </form>
            </div>
        </section>
        
        <!-- Modified: Current Stats - only 3 stats in a single row -->
        <section>
            <h2 class="section-title">Current Stats</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="current-weight">--</div>
                    <div class="stat-label">Current Weight (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="current-bmi">--</div>
                    <div class="stat-label">Current BMI</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="weight-change">--</div>
                    <div class="stat-label">30-Day Change (kg)</div>
                </div>
            </div>
        </section>
        
        <!-- Modified: Charts in side-by-side layout -->
        <section>
            <h2 class="section-title">Progress Charts</h2>
            <div class="filter-controls">
                <button class="filter-btn active" data-filter="weekly">Weekly</button>
                <button class="filter-btn" data-filter="monthly">Monthly</button>
            </div>
            
            <!-- Modified: Charts in side-by-side layout -->
            <div class="charts-row">
                <div class="chart-container">
                    <h3 class="chart-title">Weight Progress</h3>
                    <div id="weight-chart"></div>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title">BMI Progress</h3>
                    <div id="bmi-chart"></div>
                </div>
            </div>
        </section>
        
        <!-- AI Agent - Modified with voice input capabilities -->
        <section>
            <h2 class="section-title">AI Fitness Coach</h2>
            <div class="ai-section">
                <p>Chat with your AI fitness coach for personalized recommendations based on your progress data.</p>
                
                <!-- Modified: Added voice controls -->
                <div class="voice-controls">
                    <button id="voice-input-btn" class="voice-btn" title="Click to speak">
                        <i class="mic-icon">ðŸŽ¤</i>
                    </button>
                    <span id="voice-status" class="voice-status">Click the microphone to speak to your AI coach</span>
                    
                    <button id="voice-output-toggle" class="voice-btn" style="background-color: #10b981;" title="Toggle voice responses">
                        <i id="speaker-icon">ðŸ”Š</i>
                    </button>
                </div>
                
                <!-- Modified: More landscape oriented iframe -->
                <div class="chat-container">
                    <iframe
                        src="https://www.chatbase.co/chatbot-iframe/6PsfEElX5kLoAlV6eMQzw"
                        width="100%"
                        style="height: 100%; min-height: 500px; border: none; border-radius: 8px;"
                        frameborder="0"
                        id="chat-iframe"
                        title="AI Fitness Coach">
                    </iframe>
                </div>
                
                <div class="recommendations" style="display: none;">
                    <h3 style="margin-bottom: 1rem; font-size: 1.125rem; font-weight: 600;">Quick Tips</h3>
                    <div id="recommendations-list">
                        <!-- Recommendations will be added here when specifically requested -->
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Global variables
        let fitnessData = [];
        let currentFilter = 'weekly';
        let userEmail = null;
        let voiceEnabled = true;
        let currentSpeech = null;
        let recognition = null;
        
        // Initialize Google Sign-In when the page loads
        window.onload = function() {
            // Check if Google Identity Services loaded
            if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                google.accounts.id.initialize({
                    client_id: '1010970898291-q8nv22u1mbbv3mjvso048dcmsip8l9ev.apps.googleusercontent.com',
                    callback: handleCredentialResponse,
                    auto_select: false,
                    cancel_on_tap_outside: false
                });
                
                // Render the button
                google.accounts.id.renderButton(
                    document.getElementById('g_id_signin'),
                    {
                        theme: 'outline',
                        size: 'large',
                        text: 'signin_with',
                        shape: 'rectangular',
                        logo_alignment: 'left'
                    }
                );
            } else {
                // Show fallback button if Google didn't load
                document.getElementById('fallback-signin').classList.remove('hidden');
            }
        };
        
        // Fallback function to try initializing Google Sign-In
        function initializeGoogleSignIn() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                google.accounts.id.initialize({
                    client_id: '1010970898291-q8nv22u1mbbv3mjvso048dcmsip8l9ev.apps.googleusercontent.com',
                    callback: handleCredentialResponse
                });
                google.accounts.id.prompt();
            } else {
                alert('Google Sign-In is not available. Please check your internet connection and try again.');
            }
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadStoredData();
            updateCurrentStats();
            updateCharts();
            setupForm();
            setupFilters();
            setTodayDate();
            setupVoiceControls();
        });
        
        // Google Sign-In
        window.handleCredentialResponse = function(response) {
            const responsePayload = decodeJwtResponse(response.credential);
            
            // Check if the email matches the allowed email - kept as is per request
            if (responsePayload.email === 'navjitdebnath5@gmail.com') {
                userEmail = responsePayload.email;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                loadStoredData();
                updateCurrentStats();
                updateCharts();
                loadDailyRecommendations();
            } else {
                alert('Access denied. This fitness tracker is restricted to authorized users only.');
                signOut();
            }
        };
        
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }
        
        window.signOut = function() {
            userEmail = null;
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
            if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                google.accounts.id.disableAutoSelect();
            }
        };
        
        // Load data from localStorage
        function loadStoredData() {
            const stored = localStorage.getItem('fitnessData');
            if (stored) {
                fitnessData = JSON.parse(stored);
                // Sort by date
                fitnessData.sort((a, b) => new Date(a.date) - new Date(b.date));
            }
        }
        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('fitnessData', JSON.stringify(fitnessData));
        }
        
        // Set today's date as default
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }
        
        // Setup form submission
        function setupForm() {
            document.getElementById('fitness-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const entry = {
                    date: formData.get('date'),
                    weight: parseFloat(formData.get('weight')),
                    height: parseFloat(formData.get('height')),
                    bmi: calculateBMI(parseFloat(formData.get('weight')), parseFloat(formData.get('height')))
                };
                
                // Check if entry for this date already exists
                const existingIndex = fitnessData.findIndex(item => item.date === entry.date);
                if (existingIndex >= 0) {
                    if (confirm('An entry for this date already exists. Do you want to update it?')) {
                        fitnessData[existingIndex] = entry;
                    } else {
                        return;
                    }
                } else {
                    fitnessData.push(entry);
                }
                
                // Sort by date
                fitnessData.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                saveData();
                updateCurrentStats();
                updateCharts();
                
                // Clear form except date
                document.getElementById('weight').value = '';
                document.getElementById('height').value = '';
                
                alert('Entry added successfully!');
            });
        }
        
        // Calculate BMI
        function calculateBMI(weight, height) {
            return weight / Math.pow(height / 100, 2);
        }
        
        // Setup filter buttons
        function setupFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    updateCharts();
                });
            });
        }
        
        // Filter data based on current filter
        function getFilteredData() {
            if (fitnessData.length === 0) return [];
            
            const now = new Date();
            let startDate;
            
            switch (currentFilter) {
                case 'weekly':
                    startDate = new Date(now.getTime() - (12 * 7 * 24 * 60 * 60 * 1000)); // Last 12 weeks
                    break;
                case 'monthly':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 11, 1); // Last 12 months
                    break;
                default:
                    return fitnessData;
            }
            
            return fitnessData.filter(entry => new Date(entry.date) >= startDate);
        }
        
        // Update current stats - Modified to only show 3 stats
        function updateCurrentStats() {
            if (fitnessData.length === 0) {
                document.getElementById('current-weight').textContent = '--';
                document.getElementById('current-bmi').textContent = '--';
                document.getElementById('weight-change').textContent = '--';
                return;
            }
            
            const latest = fitnessData[fitnessData.length - 1];
            document.getElementById('current-weight').textContent = latest.weight.toFixed(1);
            document.getElementById('current-bmi').textContent = latest.bmi.toFixed(1);
            
            // Calculate 30-day change
            const thirtyDaysAgo = new Date(Date.now() - (30 * 24 * 60 * 60 * 1000));
            const recentEntries = fitnessData.filter(entry => new Date(entry.date) > thirtyDaysAgo);
            
            if (recentEntries.length >= 2) {
                const firstWeight = recentEntries[0].weight;
                const lastWeight = recentEntries[recentEntries.length - 1].weight;
                const change = lastWeight - firstWeight;
                const changeText = change > 0 ? `+${change.toFixed(1)}` : change.toFixed(1);
                document.getElementById('weight-change').textContent = changeText;
            } else {
                document.getElementById('weight-change').textContent = '--';
            }
        }
        
        // Modified: Update charts to be side-by-side with updated labels and averaging
        function updateCharts() {
            const filteredData = getFilteredData();
            
            if (filteredData.length === 0) {
                document.getElementById('weight-chart').innerHTML = '<p style="text-align: center; color: var(--muted-color);">No data available</p>';
                document.getElementById('bmi-chart').innerHTML = '<p style="text-align: center; color: var(--muted-color);">No data available</p>';
                return;
            }
            
            // Group data by week or month based on filter with averaging
            let groupedData;
            if (currentFilter === 'weekly') {
                groupedData = groupDataByWeek(filteredData);
            } else {
                groupedData = groupDataByMonth(filteredData);
            }
            
            // Prepare data for charts
            const labels = Object.keys(groupedData);
            const formattedLabels = labels.map(label => {
                if (currentFilter === 'weekly') {
                    return label; // Keep the week format
                } else {
                    // Format to month name (e.g., "May 2025")
                    const [year, month] = label.split('-');
                    const date = new Date(parseInt(year), parseInt(month) - 1);
                    return date.toLocaleString('default', { month: 'long', year: 'numeric' });
                }
            });
            
            const weights = labels.map(label => groupedData[label].weight);
            const bmis = labels.map(label => groupedData[label].bmi);
            
            // Weight chart
            const weightTrace = {
                x: formattedLabels,
                y: weights,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#2563eb', width: 3 },
                marker: { color: '#2563eb', size: 8 },
                name: 'Weight (kg)'
            };
            
            const weightLayout = {
                title: false,
                xaxis: { 
                    title: currentFilter === 'weekly' ? 'Week' : 'Month',
                    tickangle: -45
                },
                yaxis: { title: 'Weight (kg)' },
                margin: { t: 20, r: 20, b: 60, l: 50 },
                height: 300, // Reduced height for 4:3 aspect ratio
                width: 400, // Width for 4:3 aspect ratio
                font: { family: 'Inconsolata, monospace' }
            };
            
            Plotly.newPlot('weight-chart', [weightTrace], weightLayout, { responsive: true });
            
            // BMI chart with reference lines
            const bmiTrace = {
                x: formattedLabels,
                y: bmis,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#10b981', width: 3 },
                marker: { color: '#10b981', size: 8 },
                name: 'BMI'
            };
            
            // BMI reference lines
            const underweightLine = {
                x: formattedLabels,
                y: Array(formattedLabels.length).fill(18.5),
                type: 'scatter',
                mode: 'lines',
                line: { color: '#6b7280', width: 1, dash: 'dash' },
                name: 'Underweight (18.5)',
                showlegend: false
            };
            
            const overweightLine = {
                x: formattedLabels,
                y: Array(formattedLabels.length).fill(25),
                type: 'scatter',
                mode: 'lines',
                line: { color: '#f59e0b', width: 1, dash: 'dash' },
                name: 'Overweight (25)',
                showlegend: false
            };
            
            const obeseLine = {
                x: formattedLabels,
                y: Array(formattedLabels.length).fill(30),
                type: 'scatter',
                mode: 'lines',
                line: { color: '#ef4444', width: 1, dash: 'dash' },
                name: 'Obese (30)',
                showlegend: false
            };
            
            const bmiLayout = {
                title: false,
                xaxis: { 
                    title: currentFilter === 'weekly' ? 'Week' : 'Month',
                    tickangle: -45
                },
                yaxis: { title: 'BMI' },
                margin: { t: 20, r: 20, b: 60, l: 50 },
                height: 300, // Reduced height for 4:3 aspect ratio 
                width: 400, // Width for 4:3 aspect ratio
                font: { family: 'Inconsolata, monospace' },
                annotations: [
                    {
                        x: formattedLabels[Math.floor(formattedLabels.length / 2)],
                        y: 18.5,
                        text: 'Underweight',
                        showarrow: false,
                        font: { size: 10, color: '#6b7280' },
                        yanchor: 'bottom'
                    },
                    {
                        x: formattedLabels[Math.floor(formattedLabels.length / 2)],
                        y: 25,
                        text: 'Overweight',
                        showarrow: false,
                        font: { size: 10, color: '#f59e0b' },
                        yanchor: 'bottom'
                    },
                    {
                        x: formattedLabels[Math.floor(formattedLabels.length / 2)],
                        y: 30,
                        text: 'Obese',
                        showarrow: false,
                        font: { size: 10, color: '#ef4444' },
                        yanchor: 'bottom'
                    }
                ]
            };
            
            Plotly.newPlot('bmi-chart', [bmiTrace, underweightLine, overweightLine, obeseLine], bmiLayout, { responsive: true });
        }
        
        // Modified: Group data by week with averaging and improved date format
        function groupDataByWeek(data) {
            const grouped = {};
            
            // First, group all entries by week
            data.forEach(entry => {
                const date = new Date(entry.date);
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - date.getDay()); // Start of week (Sunday)
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6); // End of week (Saturday)
                
                const weekKey = weekStart.toISOString().split('T')[0];
                
                if (!grouped[weekKey]) {
                    grouped[weekKey] = {
                        entries: [],
                        date: weekKey,
                        weekStart: weekStart,
                        weekEnd: weekEnd
                    };
                }
                
                grouped[weekKey].entries.push(entry);
            });
            
            // Then calculate averages for each week
            Object.keys(grouped).forEach(key => {
                const entries = grouped[key].entries;
                const totalWeight = entries.reduce((sum, entry) => sum + entry.weight, 0);
                const totalBMI = entries.reduce((sum, entry) => sum + entry.bmi, 0);
                
                grouped[key].weight = totalWeight / entries.length;
                grouped[key].bmi = totalBMI / entries.length;
            });
            
            // Sort by week
            const sortedKeys = Object.keys(grouped).sort();
            const result = {};
            
            // Format the week label as "May 18 - May 24"
            sortedKeys.forEach(key => {
                const weekStart = grouped[key].weekStart;
                const weekEnd = grouped[key].weekEnd;
                
                // Format as "May 18 - May 24"
                const weekLabel = `${weekStart.toLocaleString('default', { month: 'short' })} ${weekStart.getDate()} - ${weekEnd.toLocaleString('default', { month: 'short' })} ${weekEnd.getDate()}`;
                
                result[weekLabel] = grouped[key];
            });
            
            return result;
        }
        
        // Modified: Group data by month with averaging
        function groupDataByMonth(data) {
            const grouped = {};
            
            // First, group all entries by month
            data.forEach(entry => {
                const date = new Date(entry.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!grouped[monthKey]) {
                    grouped[monthKey] = {
                        entries: [],
                        date: monthKey
                    };
                }
                
                grouped[monthKey].entries.push(entry);
            });
            
            // Then calculate averages for each month
            Object.keys(grouped).forEach(key => {
                const entries = grouped[key].entries;
                const totalWeight = entries.reduce((sum, entry) => sum + entry.weight, 0);
                const totalBMI = entries.reduce((sum, entry) => sum + entry.bmi, 0);
                
                grouped[key].weight = totalWeight / entries.length;
                grouped[key].bmi = totalBMI / entries.length;
            });
            
            return grouped;
        }
        
        // Modified: Setup voice controls for AI agent interaction with better error handling
        function setupVoiceControls() {
            const voiceButton = document.getElementById('voice-input-btn');
            const voiceStatus = document.getElementById('voice-status');
            const voiceOutputToggle = document.getElementById('voice-output-toggle');
            const speakerIcon = document.getElementById('speaker-icon');
            
            // Setup voice output toggle
            voiceOutputToggle.addEventListener('click', function() {
                voiceEnabled = !voiceEnabled;
                
                if (voiceEnabled) {
                    speakerIcon.textContent = 'ðŸ”Š';
                    voiceOutputToggle.style.backgroundColor = '#10b981';
                    voiceOutputToggle.title = 'Voice responses enabled - click to disable';
                } else {
                    speakerIcon.textContent = 'ðŸ”‡';
                    voiceOutputToggle.style.backgroundColor = '#6b7280';
                    voiceOutputToggle.title = 'Voice responses disabled - click to enable';
                    // Stop any current speech
                    if (window.speechSynthesis && window.speechSynthesis.speaking) {
                        window.speechSynthesis.cancel();
                    }
                }
            });
            
            // Setup speech recognition if available
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    voiceButton.classList.add('listening');
                    voiceStatus.textContent = 'Listening...';
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    voiceStatus.textContent = 'Processing: "' + transcript + '"';
                    
                    // Send message to chatbot iframe
                    sendMessageToIframe(transcript);
                };
                
                recognition.onerror = function(event) {
                    voiceButton.classList.remove('listening');
                    voiceStatus.textContent = 'Error: ' + event.error;
                    setTimeout(() => {
                        voiceStatus.textContent = 'Click the microphone to speak to your AI coach';
                    }, 3000);
                };
                
                recognition.onend = function() {
                    voiceButton.classList.remove('listening');
                    setTimeout(() => {
                        voiceStatus.textContent = 'Click the microphone to speak to your AI coach';
                    }, 2000);
                };
                
                voiceButton.addEventListener('click', function() {
                    try {
                        recognition.start();
                    } catch (e) {
                        // If already started, stop and restart
                        recognition.stop();
                        setTimeout(() => {
                            recognition.start();
                        }, 200);
                    }
                });
            } else {
                voiceButton.disabled = true;
                voiceStatus.textContent = 'Speech recognition not supported in this browser';
            }
            
            // Setup custom message handler for iframe communication
            window.addEventListener('message', function(event) {
                try {
                    // Check if the message is from our iframe or Chatbase
                    if (event.data) {
                        // Handle Chatbase messages
                        if (event.data.type === 'chatbase-message' && event.data.message) {
                            // If voice is enabled, speak the response
                            if (voiceEnabled) {
                                speakText(event.data.message);
                            }
                            
                            // Check if this is a recommendation or summary request
                            const message = event.data.message;
                            if (message.toLowerCase().includes('quick tip') || 
                                message.toLowerCase().includes('summarize this as a tip') ||
                                message.toLowerCase().includes('quick summary') ||
                                message.includes('ðŸ’¡')) {
                                addRecommendation(message);
                            }
                        }
                        
                        // Handle direct message responses (custom implementation)
                        if (event.data.type === 'fitness-voice-response' && event.data.text) {
                            if (voiceEnabled) {
                                speakText(event.data.text);
                            }
                            
                            if (event.data.isRecommendation) {
                                addRecommendation(event.data.text);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error handling iframe message:', error);
                }
            });
            
            // Add message listener for debugging iframe communication
            document.addEventListener('keydown', function(e) {
                // Press Alt+D to check iframe communication status (debug)
                if (e.altKey && e.key === 'd') {
                    const lastMessage = localStorage.getItem('lastVoiceMessage');
                    alert(`Last voice message: ${lastMessage || 'None'}\nIframe communication test: ${document.querySelector('iframe') ? 'Iframe found' : 'No iframe'}`);
                }
            });
        }
        
        // Setup communication with the Chatbase iframe
        function setupIframeCommunication() {
            // Wait for iframe to load
            const iframe = document.getElementById('chat-iframe');
            if (iframe) {
                iframe.onload = function() {
                    // Send a message to the iframe to initialize
                    try {
                        iframe.contentWindow.postMessage({
                            type: 'fitness-app-init',
                            message: 'Initialize communication'
                        }, '*');
                        
                        console.log('Initialized communication with chat iframe');
                    } catch (e) {
                        console.error('Error initializing iframe communication:', e);
                    }
                };
            }
        }
        
        // Function to send message to the iframe chatbot - improved for cross-origin communication
        function sendMessageToIframe(message) {
            const iframe = document.getElementById('chat-iframe');
            const voiceStatus = document.getElementById('voice-status');
            
            if (iframe) {
                try {
                    // First approach: Use postMessage API (most reliable for cross-origin iframes)
                    iframe.contentWindow.postMessage({
                        type: 'chatbase-input',
                        message: message
                    }, '*');
                    
                    // Update status
                    voiceStatus.textContent = `Message sent: "${message}"`;
                    setTimeout(() => {
                        voiceStatus.textContent = 'Click the microphone to speak to your AI coach';
                    }, 3000);
                    
                    // Simulate interaction with the chatbot UI
                    // Since we can't directly interact with cross-origin iframe content,
                    // let's implement a workaround using a custom message channel
                    
                    // Store message in localStorage for debugging/backup
                    localStorage.setItem('lastVoiceMessage', message);
                    
                    // Advanced: Setup a custom handler to retry until iframe is ready
                    checkIframeAndSendMessage(iframe, message);
                    
                } catch (e) {
                    console.error('Error sending message to iframe:', e);
                    voiceStatus.textContent = "Couldn't send message directly. Please type in the chat or try again.";
                    setTimeout(() => {
                        voiceStatus.textContent = 'Click the microphone to speak to your AI coach';
                    }, 3000);
                }
            } else {
                voiceStatus.textContent = "Chat iframe not found. Please refresh the page.";
            }
        }
        
        // Helper function to check iframe and try sending message repeatedly
        function checkIframeAndSendMessage(iframe, message) {
            let attempts = 0;
            const maxAttempts = 5;
            
            const checkInterval = setInterval(() => {
                attempts++;
                try {
                    // Try to access iframe - this will throw an error if cross-origin
                    const iframeAccess = iframe.contentWindow.document;
                    
                    // If we got here, we can access the iframe directly
                    clearInterval(checkInterval);
                    
                    // Find input field and send button
                    const inputField = iframeAccess.querySelector('input[type="text"], textarea');
                    const sendButton = iframeAccess.querySelector('button[type="submit"]');
                    
                    if (inputField && sendButton) {
                        // Set input value
                        inputField.value = message;
                        
                        // Trigger input event
                        const inputEvent = new Event('input', { bubbles: true });
                        inputField.dispatchEvent(inputEvent);
                        
                        // Click send button
                        setTimeout(() => sendButton.click(), 100);
                    }
                } catch (e) {
                    // Expected behavior for cross-origin iframe
                    // Use alternative methods
                    if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                    }
                }
            }, 500);
        }
        
        // Text-to-Speech functionality
        function speakText(text) {
            // Check if speech synthesis is available
            if (!('speechSynthesis' in window)) {
                console.log('Text-to-speech not supported in this browser');
                return;
            }
            
            // Stop any current speech
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            
            // Clean text for better speech (remove markdown or special characters)
            const cleanText = text
                .replace(/\*\*(.*?)\*\*/g, '$1')
                .replace(/\*(.*?)\*/g, '$1')
                .replace(/[â€¢\-]\s*/g, '')
                .replace(/<[^>]*>/g, '') // Remove HTML tags
                .replace(/\n/g, ' '); // Replace newlines with spaces
            
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            // Load and use available voices
            const loadVoices = function() {
                // Get available voices
                const voices = window.speechSynthesis.getVoices();
                
                // Try to find a good quality voice in this order:
                // 1. Google or Microsoft natural voices
                // 2. Any English voice
                // 3. Default voice
                const preferredVoice = voices.find(voice => 
                    voice.name.includes('Google') || 
                    voice.name.includes('Natural') || 
                    voice.name.includes('Microsoft')
                ) || voices.find(voice => 
                    voice.lang === 'en-US' || 
                    voice.lang === 'en-GB'
                ) || voices[0];
                
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                    console.log('Using voice:', preferredVoice.name);
                }
                
                // Speak the text
                window.speechSynthesis.speak(utterance);
            };
            
            // Chrome needs this event to get all voices
            if (window.speechSynthesis.onvoiceschanged !== undefined) {
                // If voices aren't loaded yet, wait for them
                if (window.speechSynthesis.getVoices().length === 0) {
                    window.speechSynthesis.onvoiceschanged = loadVoices;
                } else {
                    loadVoices();
                }
            } else {
                // For browsers that don't support onvoiceschanged
                loadVoices();
            }
        }
        
        // Add recommendation to the list - modified to only show when requested
        function addRecommendation(text) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            // Check if this is a recommendation request from the AI
            const isRecommendationRequest = text.toLowerCase().includes('quick tip') || 
                                           text.toLowerCase().includes('summarize this as a tip') || 
                                           text.toLowerCase().includes('quick summary');
            
            if (isRecommendationRequest || text.includes('ðŸ’¡')) {
                // Show the recommendations section
                const recommendationsSection = document.querySelector('.recommendations');
                recommendationsSection.style.display = 'block';
                
                const recommendationsContainer = document.getElementById('recommendations-list');
                
                // Create new recommendation element
                const recommendationElement = document.createElement('div');
                recommendationElement.className = 'recommendation-item';
                recommendationElement.innerHTML = `
                    <div class="recommendation-time">${timeString}</div>
                    <div>${text}</div>
                `;
                
                // Add at the top of the list
                recommendationsContainer.prepend(recommendationElement);
                
                // Remove oldest if more than 5
                const items = recommendationsContainer.querySelectorAll('.recommendation-item');
                if (items.length > 5) {
                    items[items.length - 1].remove();
                }
                
                // Save recommendations to localStorage
                const recommendations = JSON.parse(localStorage.getItem('dailyRecommendations') || '[]');
                recommendations.unshift({
                    time: now.toISOString(),
                    text: text
                });
                
                // Keep only the 10 most recent
                if (recommendations.length > 10) {
                    recommendations.pop();
                }
                
                localStorage.setItem('dailyRecommendations', JSON.stringify(recommendations));
            }
        }
        
        // Load daily recommendations
        function loadDailyRecommendations() {
            const today = new Date().toDateString();
            const recommendations = JSON.parse(localStorage.getItem('dailyRecommendations') || '[]');
            const todayRecommendations = recommendations.filter(rec => 
                new Date(rec.time).toDateString() === today
            );
            
            const container = document.getElementById('recommendations-list');
            const recommendationsSection = document.querySelector('.recommendations');
            
            if (todayRecommendations.length > 0) {
                container.innerHTML = '';
                todayRecommendations.slice(0, 5).forEach(rec => {
                    const time = new Date(rec.time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const element = document.createElement('div');
                    element.className = 'recommendation-item';
                    element.innerHTML = `
                        <div class="recommendation-time">${time}</div>
                        <div>${rec.text}</div>
                    `;
                    container.appendChild(element);
                });
                
                // Only show recommendations section if there are explicit recommendation requests
                const hasExplicitRecommendations = todayRecommendations.some(rec => 
                    rec.text.toLowerCase().includes('quick tip') || 
                    rec.text.toLowerCase().includes('summarize this as a tip') ||
                    rec.text.toLowerCase().includes('quick summary') ||
                    rec.text.includes('ðŸ’¡')
                );
                
                recommendationsSection.style.display = hasExplicitRecommendations ? 'block' : 'none';
            } else {
                recommendationsSection.style.display = 'none';
            }
        }
        
        // Initialize voices for speech synthesis
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = function() {
                const voices = window.speechSynthesis.getVoices();
                console.log('Available voices:', voices.length);
            };
        }
        
        // Handle errors gracefully
        window.addEventListener('error', function(e) {
            console.error('Error caught:', e.message);
            // Don't show errors to the user unless needed
            return true; // Prevents the error from being shown in console
        });
    </script>
</body>
</html>
